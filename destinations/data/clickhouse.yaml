apiVersion: internal.odigos.io/v1beta1
kind: Destination
metadata:
  type: clickhouse
  displayName: Clickhouse
  category: self hosted
spec:
  image: clickhouse.svg
  signals:
    traces:
      supported: true
    metrics:
      supported: true
    logs:
      supported: true
  fields:
    - name: CLICKHOUSE_ENDPOINT
      displayName: Endpoint
      componentType: input
      componentProps:
        type: text
        required: true
        placeholder: "http://host:port"
        tooltip: "The ClickHouse endpoint is the URL where the ClickHouse server is listening for incoming connections."
    - name: CLICKHOUSE_USERNAME
      displayName: Username
      componentType: input
      componentProps:
        type: text
        required: false
        tooltip: "If Clickhouse Authentication is used, provide the username"
    - name: CLICKHOUSE_PASSWORD
      displayName: Password
      componentType: input
      secret: true
      componentProps:
        type: password
        required: false
        tooltip: "If Clickhouse Authentication is used, provide the password"
    - name: CLICKHOUSE_CREATE_SCHEME
      displayName: Create Schema
      componentType: checkbox
      componentProps:
        required: true
        tooltip: "Should the destination create the schema for you? Set to `false` if you manage your own schema, or `true` to have Odigos create the schema for you"
      initialValue: true
    - name: CLICKHOUSE_DATABASE_NAME
      displayName: Database Name
      componentType: input
      componentProps:
        type: text
        required: true
        tooltip: "The name of the Clickhouse Database where the telemetry data will be stored. The Database will not be created when not exists, so make sure you have created it before"
      initialValue: otel

    - name: CLICKHOUSE_TLS_ENABLED
      displayName: Enable TLS
      componentType: checkbox
      initialValue: false
      componentProps:
        required: false
        tooltip: 'Secure connection'
      customReadDataLabels:
        - condition: 'true'
          title: 'TLS'
          value: 'Encrypted'
        - condition: 'false'
          title: 'TLS'
          value: 'Unencrypted'
    - name: CLICKHOUSE_CA_PEM
      displayName: Certificate Authority
      componentType: textarea
      componentProps:
        required: false
        placeholder: '-----BEGIN CERTIFICATE-----'
        tooltip: 'When using TLS, provide the CA certificate in PEM format to verify the server. If empty uses system root CA'
      renderCondition: ['CLICKHOUSE_TLS_ENABLED', '==', 'true']
      hideFromReadData: ['true']
    - name: CLICKHOUSE_CERT_PEM
      displayName: Client Certificate
      componentType: textarea
      componentProps:
        required: false
        placeholder: '-----BEGIN CERTIFICATE-----'
        tooltip: 'Client TLS certificate in PEM format for mTLS authentication'
      renderCondition: ['CLICKHOUSE_TLS_ENABLED', '==', 'true']
      hideFromReadData: ['true']
    - name: CLICKHOUSE_KEY_PEM
      displayName: Client Private Key
      componentType: textarea
      secret: true
      componentProps:
        required: false
        placeholder: '-----BEGIN PRIVATE KEY-----'
        tooltip: 'Client TLS private key in PEM format for mTLS authentication'
      renderCondition: ['CLICKHOUSE_TLS_ENABLED', '==', 'true']
      hideFromReadData: ['true']
    - name: CLICKHOUSE_INSECURE_SKIP_VERIFY
      displayName: Insecure Skip Verify
      componentType: checkbox
      initialValue: false
      componentProps:
        required: false
        tooltip: 'Skip TLS certificate verification'
      renderCondition: ['CLICKHOUSE_TLS_ENABLED', '==', 'true']

    - name: CLICKHOUSE_TRACES_TABLE
      displayName: Traces Table
      componentType: input
      componentProps:
        type: text
        required: true
        tooltip: "Name of the ClickHouse Table to use for storing trace spans. This name should be used in span queries"
      initialValue: otel_traces
      renderCondition: ["SIGNALS", "INCLUDES", "traces"]
      hideFromReadData: ["SIGNALS", "EXCLUDES", "traces"]

    - name: CLICKHOUSE_LOGS_TABLE
      displayName: Logs Table
      componentType: input
      componentProps:
        type: text
        required: true
        tooltip: "Name of the ClickHouse Table to use for storing logs"
      initialValue: otel_logs
      renderCondition: ["SIGNALS", "INCLUDES", "logs"]
      hideFromReadData: ["SIGNALS", "EXCLUDES", "logs"]

    - name: CLICKHOUSE_METRICS_TABLE_EXP_HISTOGRAM
      displayName: Metrics Table - Exp. Histogram
      componentType: input
      componentProps:
        type: text
        required: true
        tooltip: "Name of the table for storing exponential histogram metrics"
      initialValue: otel_metrics_exponential_histogram
      renderCondition: ["SIGNALS", "INCLUDES", "metrics"]
      hideFromReadData: ["SIGNALS", "EXCLUDES", "metrics"]

    - name: CLICKHOUSE_METRICS_TABLE_GAUGE
      displayName: Metrics Table - Gauge
      componentType: input
      componentProps:
        type: text
        required: true
        tooltip: "Name of the table for storing gauge metrics"
      initialValue: otel_metrics_gauge
      renderCondition: ["SIGNALS", "INCLUDES", "metrics"]
      hideFromReadData: ["SIGNALS", "EXCLUDES", "metrics"]

    - name: CLICKHOUSE_METRICS_TABLE_HISTOGRAM
      displayName: Metrics Table - Histogram
      componentType: input
      componentProps:
        type: text
        required: true
        tooltip: "Name of the table for storing histogram metrics"
      initialValue: otel_metrics_histogram
      renderCondition: ["SIGNALS", "INCLUDES", "metrics"]
      hideFromReadData: ["SIGNALS", "EXCLUDES", "metrics"]

    - name: CLICKHOUSE_METRICS_TABLE_SUM
      displayName: Metrics Table - Sum
      componentType: input
      componentProps:
        type: text
        required: true
        tooltip: "Name of the table for storing sum metrics"
      initialValue: otel_metrics_sum
      renderCondition: ["SIGNALS", "INCLUDES", "metrics"]
      hideFromReadData: ["SIGNALS", "EXCLUDES", "metrics"]

    - name: CLICKHOUSE_METRICS_TABLE_SUMMARY
      displayName: Metrics Table - Summary
      componentType: input
      componentProps:
        type: text
        required: true
        tooltip: "Name of the table for storing summary metrics"
      initialValue: otel_metrics_summary
      renderCondition: ["SIGNALS", "INCLUDES", "metrics"]
      hideFromReadData: ["SIGNALS", "EXCLUDES", "metrics"]

    - name: HYPERDX_LOG_NORMALIZER
      displayName: Enable Log Normalizer
      componentType: checkbox
      componentProps:
        required: false
        tooltip: "Enable HyperDX log normalization processor. This parses JSON from log bodies, infers severity levels, and normalizes log attributes for better querying."
      initialValue: false
      renderCondition: ["SIGNALS", "INCLUDES", "logs"]
      hideFromReadData: ["HYPERDX_LOG_NORMALIZER", "==", "false"]
      customReadDataLabels:
        - condition: 'true'
          title: 'Log Normalizer'
          value: 'Enabled'

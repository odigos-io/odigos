{{- /* ensure ResourceSizePreset is valid early */ -}}

{{- include "collector.validateSizing" . -}}

apiVersion: v1
kind: ConfigMap
metadata:
  name: odigos-configuration
  namespace: '{{ .Release.Namespace }}'
  labels:
    odigos.io/config: '1'
    odigos.io/system-object: "true"
data:
  config.yaml: |
    configVersion: 1
    {{- if .Values.clusterName }}
    clusterName: {{ .Values.clusterName }}
    {{- end }}
    {{- if .Values.centralProxy.centralBackendURL }}
    centralBackendURL: {{ .Values.centralProxy.centralBackendURL }}
    {{- end }}
    imagePrefix: {{ template "utils.imagePrefix" (dict "Values" .Values) }}
    {{- if .Values.ui.uiMode }}
    uiMode: {{ .Values.ui.uiMode }}
    {{- end }}
    {{- if .Values.ui.uiPaginationLimit }}
    uiPaginationLimit: {{ .Values.ui.uiPaginationLimit }}
    {{- end }}
    {{- if .Values.ui.uiRemoteUrl }}
    uiRemoteUrl: {{ .Values.ui.uiRemoteUrl }}
    {{- end }}
    {{- if .Values.ui.centralBackendURL }}
    centralBackendURL: {{ .Values.ui.centralBackendURL }}
    {{- end }}
    {{- if or .Values.ui.oidcTenantUrl .Values.ui.oidcClientId .Values.ui.oidcClientSecret }}
    oidc:
      {{- if .Values.ui.oidcTenantUrl }}
      tenantUrl: {{ .Values.ui.oidcTenantUrl }}
      {{- end }}
      {{- if .Values.ui.oidcClientId }}
      clientId: {{ .Values.ui.oidcClientId }}
      {{- end }}
      {{- if .Values.ui.oidcClientSecret }}
      clientSecret: secretRef:odigos-oidc
      {{- end }}
    {{- end }}
    {{- if .Values.collectorGateway }}
    {{- $gwLimiter := include "collector.gateway.memoryLimiter" . | fromYaml }}
    collectorGateway:
      MinReplicas: {{ include "collector.gateway.minReplicas" . }}
      MaxReplicas: {{ include "collector.gateway.maxReplicas" . }}
      requestMemoryMiB: {{ include "collector.gateway.memoryRequest" . }}
      limitMemoryMiB: {{ include "collector.gateway.memoryLimit" . }}
      requestCPUm: {{ include "collector.gateway.cpuRequest" . }}
      limitCPUm: {{ include "collector.gateway.cpuLimit" . }}
      memoryLimiterLimitMiB: {{ $gwLimiter.limitMiB }}
      memoryLimiterSpikeLimitMiB: {{ $gwLimiter.spikeMiB }}
      goMemLimitMiB: {{ $gwLimiter.goMiB }}
      serviceGraphDisabled: {{ .Values.collectorGateway.serviceGraphDisabled }}
      clusterMetricsEnabled: {{ .Values.collectorGateway.clusterMetricsEnabled }}
      {{- with .Values.collectorGateway.httpsProxyAddress }}
      httpsProxyAddress: {{ . }}
      {{- end }}
      {{- if .Values.collectorGateway.nodeSelector }}
      # Component-specific nodeSelector (overrides global values.yaml nodeSelector)
      nodeSelector:
        {{- toYaml .Values.collectorGateway.nodeSelector | nindent 8 }}
      {{- else if .Values.nodeSelector }}
      # Global nodeSelector from values.yaml
      nodeSelector:
        {{- toYaml .Values.nodeSelector | nindent 8 }}
      {{- end }}
      {{- if .Values.collectorGateway.deploymentName }}
      deploymentName: {{ .Values.collectorGateway.deploymentName }}
      {{- end }}
    {{- end }}
    {{- if .Values.collectorNode }}
    {{- $nodeLimiter := include "collector.node.memoryLimiter" . | fromYaml }}
    collectorNode:
      {{- with .Values.collectorNode.collectorOwnMetricsPort }}
      collectorOwnMetricsPort: {{ . }}
      {{- end }}
      requestMemoryMiB: {{ include "collector.node.memoryRequest" . }}
      limitMemoryMiB:   {{ include "collector.node.memoryLimit" . }}
      requestCPUm:      {{ include "collector.node.cpuRequest" . }}
      limitCPUm:        {{ include "collector.node.cpuLimit" . }}
      memoryLimiterLimitMiB: {{ $nodeLimiter.limitMiB }}
      memoryLimiterSpikeLimitMiB: {{ $nodeLimiter.spikeMiB }}
      goMemLimitMiB: {{ $nodeLimiter.goMiB }}
      {{- with .Values.collectorNode.k8sNodeLogsDirectory }}
      k8sNodeLogsDirectory: {{ . }}
      {{- end }}
      {{- with .Values.collectorNode.otlpExporterConfiguration}}
      otlpExporterConfiguration:
        enableDataCompression: {{ .enableDataCompression }}
        timeout: {{ .timeout }}
        retryOnFailure:
          enabled: {{ .retryOnFailure.enabled }}
          initialInterval: {{ .retryOnFailure.initialInterval }}
          maxInterval: {{ .retryOnFailure.maxInterval }}
          maxElapsedTime: {{ .retryOnFailure.maxElapsedTime }}
      {{- end }}
    {{- end }}
    {{- if include "utils.shouldRenderUserInstrumentationEnvs" . | eq "true" }}
    userInstrumentationEnvs:
      languages:
        {{- range $lang, $config := .Values.userInstrumentationEnvs.languages }}
        {{- if or $config.enabled $config.env }}
        {{ $lang }}:
          enabled: {{ $config.enabled }}
          {{- if $config.env }}
          env:
            {{- range $key, $value := $config.env }}
            {{ $key }}: {{ $value | quote }}
            {{- end }}
          {{- end }}
        {{- end }}
        {{- end }}
    {{- end }}
    {{- if .Values.profiles }}
      {{- if not (kindIs "slice" .Values.profiles) }}
        {{- fail "Invalid 'profiles' value: must be a list. Example (YAML): profiles: [PROFILE_NAME]  |  CLI: --set profiles={PROFILE_NAME}" }}
      {{- end }}
    profiles:
      {{- toYaml .Values.profiles | nindent 6 }}
    {{- end }}
    telemetryEnabled: {{ .Values.telemetry.enabled }}
    openshiftEnabled: {{ .Values.openshift.enabled }}
    psp: {{ .Values.psp.enabled }}
    {{- if .Values.ignoredNamespaces }}
    ignoredNamespaces:
      {{- toYaml .Values.ignoredNamespaces | nindent 6 }}
    {{- end }}
    {{- if .Values.ignoredContainers }}
    ignoredContainers:
      {{- toYaml .Values.ignoredContainers | nindent 6 }}
    {{- end }}
    {{- if kindIs "bool" .Values.ignoreOdigosNamespace }}
    ignoreOdigosNamespace: {{ .Values.ignoreOdigosNamespace }}
    {{- else }}
    ignoreOdigosNamespace: true
    {{- end }}
    {{- if .Values.instrumentor.mountMethod }}
      {{- if has .Values.instrumentor.mountMethod (list "k8s-host-path" "k8s-virtual-device" "k8s-init-container") }}
    mountMethod: {{ .Values.instrumentor.mountMethod }}
      {{- else }}
        {{- fail "Error: Invalid mountMethod. Supported values are 'k8s-host-path', 'k8s-virtual-device' and 'k8s-init-container'." }}
      {{- end }}
    {{- end }}
    {{- if .Values.instrumentor.checkDeviceHealthBeforeInjection }}
    checkDeviceHealthBeforeInjection: {{ .Values.instrumentor.checkDeviceHealthBeforeInjection }}
    {{- end }}
    {{- if .Values.instrumentor.agentsInitContainerResources }}
    agentsInitContainerResources:
      {{- if .Values.instrumentor.agentsInitContainerResources.requests.cpu }}
      requestCPUm: {{ .Values.instrumentor.agentsInitContainerResources.requests.cpu | toString | replace "m" "" | int }}
      {{- end }}
      {{- if .Values.instrumentor.agentsInitContainerResources.limits.cpu }}
      limitCPUm: {{ .Values.instrumentor.agentsInitContainerResources.limits.cpu | toString | replace "m" "" | int }}
      {{- end }}
      {{- if .Values.instrumentor.agentsInitContainerResources.requests.memory }}
      requestMemoryMiB: {{ .Values.instrumentor.agentsInitContainerResources.requests.memory | toString | replace "Mi" "" | int }}
      {{- end }}
      {{- if .Values.instrumentor.agentsInitContainerResources.limits.memory }}
      limitMemoryMiB: {{ .Values.instrumentor.agentsInitContainerResources.limits.memory | toString | replace "Mi" "" | int }}
      {{- end }}
    {{- end }}
    {{- if .Values.ResourceSizePreset }}
    resourceSizePreset: {{ .Values.ResourceSizePreset }}
    {{- end }}
    {{- $envMethod := .Values.instrumentor.agentEnvVarsInjectionMethod }}
    {{- if and $envMethod (not (has $envMethod (list "loader" "pod-manifest" "loader-fallback-to-pod-manifest"))) }}
    {{- fail "Error: Invalid agentEnvVarsInjectionMethod. Supported values are 'loader', 'pod-manifest', and 'loader-fallback-to-pod-manifest'." }}
    {{- else if $envMethod }}
    agentEnvVarsInjectionMethod: {{ $envMethod }}
    {{- end }}
    {{- if .Values.nodeSelector }}
    nodeSelector:
      {{- toYaml .Values.nodeSelector | nindent 6 }}
    {{- end }}
    {{- if .Values.karpenter.enabled }}
    karpenterEnabled: {{ .Values.karpenter.enabled }}
    {{- end }}
    {{- if .Values.autoRollback.disabled }}
    rollbackDisabled: {{ .Values.autoRollback.disabled }}
    {{- end }}
    {{- if .Values.autoRollback.graceTime }}
    rollbackGraceTime: {{ .Values.autoRollback.graceTime }}
    {{- end }}
    {{- if .Values.autoRollback.stabilityWindowTime }}
    rollbackStabilityWindow: {{ .Values.autoRollback.stabilityWindowTime }}
    {{- end }}
    {{- if .Values.rollout }}
    rollout:
      {{- if .Values.rollout.automaticRolloutDisabled }}
      automaticRolloutDisabled: {{ .Values.rollout.automaticRolloutDisabled }}
      {{- end }}
    {{- end }}
    {{- if .Values.clickhouseDestinationJsonType.enabled }}
    clickhouseDestinationJsonType: {{ .Values.clickhouseDestinationJsonType.enabled }}
    {{- end }}
    {{- if .Values.allowConcurrentAgents.enabled }}
    allowConcurrentAgents: {{ .Values.allowConcurrentAgents.enabled }}
    {{- end }}
    {{- if .Values.wasp.enabled }}
    waspEnabled: {{ .Values.wasp.enabled }}
    {{- end }}
    {{- if .Values.goAutoOffsetsCron }}
    goAutoOffsetsCron: {{ .Values.goAutoOffsetsCron }}
    {{- end }}
    {{- if .Values.goAutoOffsetsMode }}
    goAutoOffsetsMode: {{ quote .Values.goAutoOffsetsMode }}
    {{- end }}
    {{- if .Values.metricsSources }}
    metricsSources:
      {{- toYaml .Values.metricsSources | nindent 6 }}
    {{- end }}
    {{- if .Values.odiglet.traceIdSuffix }}
    traceIdSuffix: {{ .Values.odiglet.traceIdSuffix }}
    {{- end }}
    odigosOwnTelemetryStore:
      {{- if .Values.ownTelemetry.metricsStore.disabled }}
      metricsStoreDisabled: {{ .Values.ownTelemetry.metricsStore.disabled }}
      {{- end }}
    {{- if .Values.imagePullSecrets }}
    imagePullSecrets:
      {{- toYaml .Values.imagePullSecrets | nindent 6 }}
    {{- end }}

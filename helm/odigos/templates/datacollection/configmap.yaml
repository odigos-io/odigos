{{/*
    This ConfigMap is special:

    - Normally Helm would re-apply (and overwrite) ConfigMaps on every upgrade.
    - But this ConfigMap (`odigos-data-collection`) is managed dynamically at runtime
      by the Odigos autoscaler / controller. It needs to be created once so the
      collector can start, but then it must not be touched by Helm again.
    - To achieve this, we use `lookup` to check if the ConfigMap already exists:
        * If it does not exist → Helm creates a minimal stub ConfigMap.
        * If it already exists → Helm does nothing, so the autoscaler’s config
          remains untouched.
*/}}
{{- $existing := lookup "v1" "ConfigMap" .Release.Namespace "odigos-data-collection" }}
{{- if not $existing }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: odigos-data-collection
  namespace: {{ .Release.Namespace }}
  labels:
    odigos.io/system-object: "true"
    odigos.io/preserve: "true"
data:
  conf: |
    receivers:
      otlp:
        protocols:
          grpc:
          http:

    extensions:
      health_check:
        endpoint: 0.0.0.0:13133

    exporters:
      nop:

    service:
      extensions: [health_check]
      pipelines:
        traces:
          receivers: [otlp]
          exporters: [nop]
{{- end }}

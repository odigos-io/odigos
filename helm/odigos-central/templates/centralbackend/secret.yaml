{{- if (include "odigos.secretExists" .) }}
{{- $existingSecret := lookup "v1" "Secret" .Release.Namespace "odigos-central" }}
{{- $onPremToken := "" }}
{{- if $existingSecret }}
  {{- /* Secret exists - reuse existing token to preserve it across upgrades */}}
  {{- $onPremToken = index $existingSecret.data "ODIGOS_ONPREM_TOKEN" | b64dec }}
{{- else if .Values.onPremToken }}
  {{- /* First install with explicit token */}}
  {{- $onPremToken = .Values.onPremToken }}
{{- end }}
{{- if $onPremToken }}
apiVersion: v1
kind: Secret
metadata:
  name: odigos-central
  namespace: {{ .Release.Namespace }}
  labels:
    odigos.io/system-object: "true"
type: Opaque
stringData:
  ODIGOS_ONPREM_TOKEN: {{ $onPremToken | quote }}
{{- end }}
{{- end }}

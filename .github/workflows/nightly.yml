name: Nightly

on:
  schedule:
    - cron: '0 0 * * *' # Nightly run at midnight
  workflow_call:
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  build-images:
    uses: ./.github/workflows/build-dev-images.yml

  chaos-tests:
    runs-on: warp-ubuntu-latest-x64-8x-spot
    needs: build-images
    steps:
      - name: Run chaos-tests
        uses: ./.github/workflows/run-chaos-tests.yml

      - name: Report Test Outcome
        if: always()
        uses: ./.github/actions/report-outcome
        with:
          status: ${{ job.status }}
          suite_name: cross-cloud-tests
          suite_parameters: '{}'
          slack_webhook_url: ${{ secrets.CLOUD_PROVIDERS_TESTS_WEBHOOK_URL }}

  cross-cloud-tests:
      runs-on: warp-ubuntu-latest-x64-8x-spot
      needs: build-images
      strategy:
        fail-fast: false
        matrix:
          provider: [eks, aks] # Add or remove providers as needed [TODO: later add -> gke]
          test_scenario: [multi-apps, helm-chart] # Add or remove scenarios as needed
      steps:
        - name: Run cross-cloud tests
          uses: ./.github/workflows/run-cross-cloud-tests.yml
          with:
            parameters: '{"provider": "${{ matrix.provider }}", "test_scenario": "${{ matrix.test_scenario }}"}'
        - name: Report Test Outcome
          if: always()
          uses: ./.github/actions/report-outcome
          with:
            status: ${{ job.status }}
            suite_name: cross-cloud-tests
            suite_parameters: '{"provider": "${{ matrix.provider }}", "test_scenario": "${{ matrix.test_scenario }}"}'
            slack_webhook_url: ${{ secrets.CLOUD_PROVIDERS_TESTS_WEBHOOK_URL }}

name: Publish Modules

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'image tag'
        required: true
      force_run_on_zero_patch:
        description: 'Run even when tag is <MAJOR>.<MINOR>.0'
        required: false
        default: "false"

jobs:
  # Skip tags that are exactly v<MAJOR>.<MINOR>.0
  # unless force_run_on_zero_patch is "true".
  # This prevents publishing modules when a promote-rc-to-stable tag is created,
  # but allows overriding manually by setting force_run_on_zero_patch to "true"
  # when dispatching the workflow.
  decide:
    runs-on: ubuntu-latest
    outputs:
      skip: ${{ steps.decide.outputs.skip }}
      tag:  ${{ steps.decide.outputs.tag }}
    steps:
      - id: decide
        env:
          # Prefer manual input for dispatch; otherwise use the pushed tag
          TAG:   ${{ inputs.tag != '' && inputs.tag || github.ref_name }}
          # If workflow_dispatch, this can be set to "true" to override skipping
          FORCE: ${{ github.event_name == 'workflow_dispatch' && inputs.force_run_on_zero_patch || 'false' }}
        run: |
          echo "tag=${TAG}" >> "$GITHUB_OUTPUT"

          if [[ "$TAG" =~ ^v?[0-9]+\.[0-9]+\.0$ ]]; then
            if [[ "$FORCE" == "true" ]]; then
              echo "skip=false" >> "$GITHUB_OUTPUT"
            else
              echo "skip=true" >> "$GITHUB_OUTPUT"
            fi
          else
            echo "skip=false" >> "$GITHUB_OUTPUT"
          fi

  verify-offsets:
    needs: decide
    if: ${{ needs.decide.outputs.skip != 'true' }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        repo: ['enterprise-go-instrumentation']
    steps:
      - name: Verify no open offsets PRs
        id: verify
        run: |
          # Fetch open PRs and filter by "offsets" label
          result=$(curl -s -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.RELEASE_BOT_TOKEN }}" \
            "https://api.github.com/repos/odigos-io/${{ matrix.repo }}/pulls?state=open&per_page=100")

          pr_links=$(echo "$result" \
            | jq -r '[.[] | select(.labels | any(.name == "offsets")) | .html_url] | join(" ")')

          count=$(echo "$pr_links" | wc -w)
          if [ "$count" -gt 0 ]; then
            # Format PR links for display
            pr_links_formatted=$(echo "$pr_links" | tr ' ' '\n' | awk '{print "- " $0}' | tr '\n' '\n')

            # Write outputs to GITHUB_OUTPUT instead of using ::set-output
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "links=$pr_links" >> $GITHUB_OUTPUT
            echo "links_formatted=$pr_links_formatted" >> $GITHUB_OUTPUT
            echo "❌ Error: Open PRs with label \"offsets\" found!" >&2
            exit 1
          else
            echo "status=success" >> $GITHUB_OUTPUT
            echo "✅ No open PRs with label \"offsets\"."
          fi

      - name: Notify Slack
        if: always()
        uses: odigos-io/ci-core/.github/actions/slack-release-notification@main
        with:
          webhook-url: ${{ secrets.ODIGOS_RELEASE_STATUS_WEBHOOK_URL }}
          success-description: "No open offset PRs in `${{ matrix.repo }}`"
          failure-description: "ERROR: Open offset PRs found in `${{ matrix.repo }}`\n\n${{ steps.verify.outputs.links_formatted }}"

  verify-dependencies-sync:
    if: ${{ needs.decide.outputs.skip != 'true' }}
    needs: verify-offsets
    runs-on: ubuntu-latest
    strategy:
      matrix:
        repo: ['odigos-enterprise']
    steps:
      - name: Verify no open dependencies-syncer-bot PRs
        id: verify
        run: |
          # Fetch open PRs and filter by "dependencies-syncer-bot" label
          result=$(curl -s -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.RELEASE_BOT_TOKEN }}" \
            "https://api.github.com/repos/odigos-io/${{ matrix.repo }}/pulls?state=open&per_page=100")

          pr_links=$(echo "$result" \
            | jq -r '[.[] | select(.labels | any(.name == "dependencies-syncer-bot")) | .html_url] | join(" ")')

          count=$(echo "$pr_links" | wc -w)
          if [ "$count" -gt 0 ]; then
            # Format PR links for display
            pr_links_formatted=$(echo "$pr_links" | tr ' ' '\n' | awk '{print "- " $0}' | tr '\n' '\n')

            # Write outputs to GITHUB_OUTPUT instead of using ::set-output
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "links=$pr_links" >> $GITHUB_OUTPUT
            echo "pr_links_formatted=$pr_links_formatted" >> $GITHUB_OUTPUT
            echo "❌ Error: Open PRs with label \"dependencies-syncer-bot\" found!" >&2
            exit 1
          else
            echo "status=success" >> $GITHUB_OUTPUT
            echo "✅ No open PRs with label \"dependencies-syncer-bot\"."
          fi

      - name: Notify Slack
        if: always()
        uses: odigos-io/ci-core/.github/actions/slack-release-notification@main
        with:
          webhook-url: ${{ secrets.ODIGOS_RELEASE_STATUS_WEBHOOK_URL }}
          success-description: "No open dependencies-syncer-bot PRs in `${{ matrix.repo }}`"
          failure-description: "ERROR: Open dependencies-syncer-bot PRs found in `${{ matrix.repo }}`\n\n${{ steps.verify.outputs.pr_links_formatted }}"

  verify-release-blockers:
    if: ${{ needs.decide.outputs.skip != 'true' }}
    needs: verify-dependencies-sync
    runs-on: ubuntu-latest
    strategy:
      matrix:
        repo: ['odigos', 'odigos-enterprise']
    steps:
      - name: Verify no open release-blocker PRs
        id: verify
        run: |
          # Fetch open PRs and filter by "release-blocker" label
          result=$(curl -s -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.RELEASE_BOT_TOKEN }}" \
            "https://api.github.com/repos/odigos-io/${{ matrix.repo }}/pulls?state=open&per_page=100")

          pr_links=$(echo "$result" \
            | jq -r '[.[] | select(.labels | any(.name == "release-blocker")) | .html_url] | join(" ")')

          count=$(echo "$pr_links" | wc -w)
          if [ "$count" -gt 0 ]; then
            # Format PR links for display
            pr_links_formatted=$(echo "$pr_links" | tr ' ' '\n' | awk '{print "- " $0}' | tr '\n' '\n')

            # Write outputs to GITHUB_OUTPUT instead of using ::set-output
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "links=$pr_links" >> $GITHUB_OUTPUT
            echo "pr_links_formatted=$pr_links_formatted" >> $GITHUB_OUTPUT
            echo "❌ Error: Open PRs with label \"release-blocker\" found!" >&2
            exit 1
          else
            echo "status=success" >> $GITHUB_OUTPUT
            echo "✅ No open PRs with label \"release-blocker\"."
          fi

      - name: Notify Slack
        if: always()
        uses: odigos-io/ci-core/.github/actions/slack-release-notification@main
        with:
          webhook-url: ${{ secrets.ODIGOS_RELEASE_STATUS_WEBHOOK_URL }}
          success-description: "No open release-blocker PRs in `${{ matrix.repo }}`"
          failure-description: "ERROR: Open release-blocker PRs found in `${{ matrix.repo }}`\n\n${{ steps.verify.outputs.pr_links_formatted }}"

  print-tag:
    if: ${{ needs.decide.outputs.skip != 'true' }}
    needs: verify-release-blockers
    runs-on: ubuntu-latest
    steps:
      - name: Extract Tag
        id: extract_tag
        run: echo "tag=${GITHUB_REF#refs/*/}" >> $GITHUB_OUTPUT

      - name: Notify Slack Start
        uses: odigos-io/ci-core/.github/actions/slack-release-notification@main
        with:
          webhook-url: ${{ secrets.ODIGOS_RELEASE_STATUS_WEBHOOK_URL }}
          success-description: "detected new git tag ${{ steps.extract_tag.outputs.tag }}, starting a release"
          failure-description: "error during detection of new git tag ${{ steps.extract_tag.outputs.tag }}"
          tag: ${{ steps.extract_tag.outputs.tag }}

  tag-modules:
    if: ${{ needs.decide.outputs.skip != 'true' }}
    needs: verify-release-blockers
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0 # Fetch all history for all tags and branches
          token: ${{ secrets.RELEASE_BOT_TOKEN }}

      - name: Extract Tag
        id: extract_tag
        run: echo "tag=${GITHUB_REF#refs/*/}" >> $GITHUB_OUTPUT

      - name: Notify Slack Start
        uses: odigos-io/ci-core/.github/actions/slack-release-notification@main
        with:
          webhook-url: ${{ secrets.ODIGOS_RELEASE_STATUS_WEBHOOK_URL }}
          success-description: "start tagging odigos modules so they can be consumed as libraries"
          failure-description: "error during tagging of odigos modules"
          tag: ${{ steps.extract_tag.outputs.tag }}

      - name: Tag Modules
        uses: ./.github/actions/tag-modules
        with:
          tag: ${{ steps.extract_tag.outputs.tag }}

      - name: Trigger Release PR in Odigos Enterprise
        run: |
          curl -X POST \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: token ${{ secrets.RELEASE_BOT_TOKEN }}" \
          https://api.github.com/repos/odigos-io/odigos-enterprise/dispatches \
            -d '{"event_type": "create_release_pr", "client_payload": {"tag": "${{ steps.extract_tag.outputs.tag }}"}}'

      - name: Notify Slack Success
        if: always()
        uses: odigos-io/ci-core/.github/actions/slack-release-notification@main
        with:
          webhook-url: ${{ secrets.ODIGOS_RELEASE_STATUS_WEBHOOK_URL }}
          success-description: "Odigos go modules tagged successfully"
          failure-description: "ERROR: Odigos go modules tagging failed"
          tag: ${{ steps.extract_tag.outputs.tag }}

  publish-images:
    if: ${{ needs.decide.outputs.skip != 'true' }}
    needs: verify-release-blockers
    permissions:
      contents: 'read'
      id-token: 'write'
      packages: 'write'
    strategy:
      matrix:
        dockerfile: ['Dockerfile', 'Dockerfile.rhel']
        service: ['autoscaler', 'scheduler', 'instrumentor', 'collector', 'odiglet', 'ui', 'operator', 'agents']
        include:
          - service: autoscaler
            runner: ubuntu-latest
            summary: 'Autoscaler for Odigos'
            description: 'Autoscaler manages the installation of Odigos components.'
          - service: scheduler
            runner: ubuntu-latest
            summary: 'Scheduler for Odigos'
            description: 'Scheduler manages the installation of OpenTelemetry Collectors with Odigos.'
          - service: instrumentor
            runner: ubuntu-latest
            summary: 'Instrumentor for Odigos'
            description: 'Instrumentor manages auto-instrumentation for workloads with Odigos.'
          - service: collector
            runner: large-runner
            summary: 'Odigos Collector'
            description: 'The Odigos build of the OpenTelemetry Collector.'
          - service: odiglet
            runner: ubuntu-latest
            summary: 'Odiglet for Odigos'
            description: 'Odiglet is the core component of Odigos managing auto-instrumentation. This image requires a root user to load and manage eBPF programs.'
          - service: ui
            runner: ubuntu-latest
            summary: 'UI for Odigos'
            description: 'UI provides the frontend webapp for managing an Odigos installation.'
          - service: operator
            runner: ubuntu-latest
            summary: 'Odigos Operator'
            description: 'The Odigos Operator installs and manages Odigos in a cluster'
          - service: agents
            runner: ubuntu-latest
            summary: 'Odigos Agents'
            description: 'The Odigos Agents used to copy Odigos agent relevant files into the user workloads.'
    runs-on: ${{ matrix.runner }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Extract Tag
        id: extract_tag
        run: echo "tag=${GITHUB_REF#refs/*/}" >> $GITHUB_OUTPUT

      - name: Notify Slack Start
        uses: odigos-io/ci-core/.github/actions/slack-release-notification@main
        with:
          webhook-url: ${{ secrets.ODIGOS_RELEASE_STATUS_WEBHOOK_URL }}
          success-description: "start publishing docker image for component ${{ matrix.service }} and dockerfile ${{ matrix.dockerfile }}"
          failure-description: "error during building or publishing of docker image for component ${{ matrix.service }} and dockerfile ${{ matrix.dockerfile }}"
          tag: ${{ steps.extract_tag.outputs.tag }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - id: gcp-auth
        name: Authenticate with Google Cloud
        uses: google-github-actions/auth@v3
        with:
          token_format: 'access_token'
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}
          access_token_lifetime: 1200s

      - name: Login to Artifact Registry
        uses: docker/login-action@v3
        with:
          registry: us-central1-docker.pkg.dev
          username: oauth2accesstoken
          password: ${{ steps.gcp-auth.outputs.access_token }}

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and Push Docker Image for ${{ matrix.service }}
        uses: docker/build-push-action@v6
        env:
          ODIGOS_TAG: ${{ github.event_name == 'workflow_dispatch' && inputs.tag || steps.extract_tag.outputs.tag}}
        with:
          push: true
          provenance: false
          tags: |
            us-central1-docker.pkg.dev/odigos-cloud/components/odigos-${{ matrix.service }}${{ matrix.dockerfile == 'Dockerfile.rhel' && '-ubi9' || '' }}:${{ env.ODIGOS_TAG }}
            keyval/odigos-${{ matrix.service }}${{ matrix.dockerfile == 'Dockerfile.rhel' && '-ubi9' || '' }}:${{ env.ODIGOS_TAG }}
            ghcr.io/odigos-io/odigos-${{ matrix.service }}${{ matrix.dockerfile == 'Dockerfile.rhel' && '-ubi9' || '' }}:${{ env.ODIGOS_TAG }}
          build-args: |
            SERVICE_NAME=${{ matrix.service }}
            ODIGOS_VERSION=${{ env.ODIGOS_TAG }}
            RELEASE=${{ env.ODIGOS_TAG }}
            VERSION=${{ env.ODIGOS_TAG }}
            SUMMARY=${{ matrix.summary }}
            DESCRIPTION=${{ matrix.description }}
            LD_FLAGS=-s -w
          platforms: linux/amd64,linux/arm64
          file: >-
            ${{ matrix.service == 'odiglet' && format('odiglet/{0}', matrix.dockerfile) ||
                matrix.service == 'collector' && format('collector/{0}', matrix.dockerfile) ||
                matrix.service == 'ui' && format('frontend/{0}', matrix.dockerfile) ||
                matrix.service == 'operator' && format('operator/{0}', matrix.dockerfile) ||
                matrix.service == 'agents' && format('agents/{0}', matrix.dockerfile) ||
                matrix.dockerfile }}

      - name: Notify Slack
        if: always()
        uses: odigos-io/ci-core/.github/actions/slack-release-notification@main
        with:
          webhook-url: ${{ secrets.ODIGOS_RELEASE_STATUS_WEBHOOK_URL }}
          success-description: "Odigos component ${{ matrix.service }} with dockerfile ${{ matrix.dockerfile }} released successfully"
          failure-description: "ERROR: Odigos component ${{ matrix.service }} with dockerfile ${{ matrix.dockerfile }} release failed"
          tag: ${{ steps.extract_tag.outputs.tag }}

  publish-collector-linux-packages:
    if: ${{ needs.decide.outputs.skip != 'true' }}
    needs: verify-release-blockers
    runs-on: depot-ubuntu-24.04-8
    steps:
      - name: Extract Tag
        id: extract_tag
        run: echo "tag=${GITHUB_REF#refs/*/}" >> $GITHUB_OUTPUT

      - name: Notify Slack Start
        if: always()
        uses: odigos-io/ci-core/.github/actions/slack-release-notification@main
        with:
          webhook-url: ${{ secrets.ODIGOS_RELEASE_STATUS_WEBHOOK_URL }}
          success-description: "start releasing odigos collector as linux packages"
          failure-description: "error during releasing of odigos collector as linux packages"
          tag: ${{ steps.extract_tag.outputs.tag }}

      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          ref: ${{ steps.extract_tag.outputs.tag }}

      - name: Install GemFury CLI
        run: |
          sudo bash -c "echo 'deb [trusted=yes] https://apt.fury.io/cli/ * *' > /etc/apt/sources.list.d/fury-cli.list"
          sudo apt-get update
          sudo apt-get install -y fury-cli

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: "1.25"

      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser
          version: latest
          args: release --clean
          workdir: collector
        env:
          FURY_ACCOUNT: ${{ secrets.FURY_ACCOUNT }}
          FURY_API_TOKEN: ${{ secrets.FURY_API_TOKEN }}

      - name: Notify Slack Success
        if: always()
        uses: odigos-io/ci-core/.github/actions/slack-release-notification@main
        with:
          webhook-url: ${{ secrets.ODIGOS_RELEASE_STATUS_WEBHOOK_URL }}
          success-description: "Odigos collector linux packages released successfully"
          failure-description: "ERROR: Odigos collector linux packages release failed"
          tag: ${{ steps.extract_tag.outputs.tag }}

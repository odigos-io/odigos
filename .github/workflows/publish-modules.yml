name: Publish Modules

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'image tag'
        required: true
      force_run_on_zero_patch:
        description: 'Run even when tag is <MAJOR>.<MINOR>.0'
        required: false
        default: "false"

jobs:
  # Skip tags that are exactly v<MAJOR>.<MINOR>.0
  # unless force_run_on_zero_patch is "true".
  # This prevents publishing modules when a promote-rc-to-stable tag is created,
  # but allows overriding manually by setting force_run_on_zero_patch to "true"
  # when dispatching the workflow.
  decide:
    runs-on: ubuntu-latest
    outputs:
      skip: ${{ steps.decide.outputs.skip }}
      tag:  ${{ steps.decide.outputs.tag }}
    steps:
      - id: decide
        env:
          # Prefer manual input for dispatch; otherwise use the pushed tag
          TAG:   ${{ inputs.tag != '' && inputs.tag || github.ref_name }}
          # If workflow_dispatch, this can be set to "true" to override skipping
          FORCE: ${{ github.event_name == 'workflow_dispatch' && inputs.force_run_on_zero_patch || 'false' }}
        run: |
          echo "tag=${TAG}" >> "$GITHUB_OUTPUT"

          if [[ "$TAG" =~ ^v?[0-9]+\.[0-9]+\.0$ ]]; then
            if [[ "$FORCE" == "true" ]]; then
              echo "skip=false" >> "$GITHUB_OUTPUT"
            else
              echo "skip=true" >> "$GITHUB_OUTPUT"
            fi
          else
            echo "skip=false" >> "$GITHUB_OUTPUT"
          fi


  print-tag:
    if: ${{ needs.decide.outputs.skip != 'true' }}
    needs: decide
    runs-on: ubuntu-latest
    steps:
      - name: Extract Tag
        id: extract_tag
        run: echo "tag=${GITHUB_REF#refs/*/}" >> $GITHUB_OUTPUT

      - name: Notify Slack Start
        uses: odigos-io/ci-core/.github/actions/slack-release-notification@main
        with:
          webhook-url: ${{ secrets.ODIGOS_RELEASE_STATUS_WEBHOOK_URL }}
          success-description: "detected new git tag ${{ steps.extract_tag.outputs.tag }}, starting a release"
          failure-description: "error during detection of new git tag ${{ steps.extract_tag.outputs.tag }}"
          tag: ${{ steps.extract_tag.outputs.tag }}

  tag-modules:
    if: ${{ needs.decide.outputs.skip != 'true' }}
    needs: decide
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0 # Fetch all history for all tags and branches
          token: ${{ secrets.RELEASE_BOT_TOKEN }}

      - name: Extract Tag
        id: extract_tag
        run: echo "tag=${GITHUB_REF#refs/*/}" >> $GITHUB_OUTPUT

      - name: Notify Slack Start
        uses: odigos-io/ci-core/.github/actions/slack-release-notification@main
        with:
          webhook-url: ${{ secrets.ODIGOS_RELEASE_STATUS_WEBHOOK_URL }}
          success-description: "start tagging odigos modules so they can be consumed as libraries"
          failure-description: "error during tagging of odigos modules"
          tag: ${{ steps.extract_tag.outputs.tag }}

      - name: Tag Modules
        uses: ./.github/actions/tag-modules
        with:
          tag: ${{ steps.extract_tag.outputs.tag }}

      - name: Trigger Release PR in Odigos Enterprise
        run: |
          curl -X POST \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: token ${{ secrets.RELEASE_BOT_TOKEN }}" \
          https://api.github.com/repos/odigos-io/odigos-enterprise/dispatches \
            -d '{"event_type": "create_release_pr", "client_payload": {"tag": "${{ steps.extract_tag.outputs.tag }}"}}'

      - name: Notify Slack Success
        if: always()
        uses: odigos-io/ci-core/.github/actions/slack-release-notification@main
        with:
          webhook-url: ${{ secrets.ODIGOS_RELEASE_STATUS_WEBHOOK_URL }}
          success-description: "Odigos go modules tagged successfully"
          failure-description: "ERROR: Odigos go modules tagging failed"
          tag: ${{ steps.extract_tag.outputs.tag }}

  publish-images:
    if: ${{ needs.decide.outputs.skip != 'true' }}
    needs: decide
    permissions:
      contents: 'read'
      id-token: 'write'
      packages: 'write'
    strategy:
      matrix:
        rhel: ['true', 'false']
        service: ['autoscaler', 'scheduler', 'instrumentor', 'collector', 'odiglet', 'odiglet-minimal', 'ui', 'operator', 'agents']
        include:
          - service: autoscaler
            runner: ubuntu-latest
            summary: 'Autoscaler for Odigos'
            description: 'Autoscaler manages the installation of Odigos components.'
          - service: scheduler
            runner: ubuntu-latest
            summary: 'Scheduler for Odigos'
            description: 'Scheduler manages the installation of OpenTelemetry Collectors with Odigos.'
          - service: instrumentor
            runner: ubuntu-latest
            summary: 'Instrumentor for Odigos'
            description: 'Instrumentor manages auto-instrumentation for workloads with Odigos.'
          - service: collector
            runner: large-runner
            summary: 'Odigos Collector'
            description: 'The Odigos build of the OpenTelemetry Collector.'
          - service: odiglet
            runner: ubuntu-latest
            summary: 'Odiglet for Odigos'
            description: 'Odiglet is the core component of Odigos managing auto-instrumentation. This image requires a root user to load and manage eBPF programs.'
          - service: odiglet-minimal
            runner: ubuntu-latest
            summary: 'Odiglet for Odigos (minimal)'
            description: 'Odiglet is the core component of Odigos managing auto-instrumentation. This minimal image excludes PHP, .NET, and Ruby agents.'
          - service: ui
            runner: ubuntu-latest
            summary: 'UI for Odigos'
            description: 'UI provides the frontend webapp for managing an Odigos installation.'
          - service: operator
            runner: ubuntu-latest
            summary: 'Odigos Operator'
            description: 'The Odigos Operator installs and manages Odigos in a cluster'
          - service: agents
            runner: ubuntu-latest
            summary: 'Odigos Agents'
            description: 'The Odigos Agents used to copy Odigos agent relevant files into the user workloads.'
    runs-on: ${{ matrix.runner }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Extract Tag
        id: extract_tag
        run: echo "tag=${GITHUB_REF#refs/*/}" >> $GITHUB_OUTPUT

      - name: Notify Slack Start
        uses: odigos-io/ci-core/.github/actions/slack-release-notification@main
        with:
          webhook-url: ${{ secrets.ODIGOS_RELEASE_STATUS_WEBHOOK_URL }}
          success-description: "start publishing docker image for component ${{ matrix.service }} and dockerfile ${{ matrix.dockerfile }}"
          failure-description: "error during building or publishing of docker image for component ${{ matrix.service }} and dockerfile ${{ matrix.dockerfile }}"
          tag: ${{ steps.extract_tag.outputs.tag }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - id: gcp-auth
        name: Authenticate with Google Cloud
        uses: google-github-actions/auth@v3
        with:
          token_format: 'access_token'
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}
          access_token_lifetime: 1200s

      - name: Login to Artifact Registry
        uses: docker/login-action@v3
        with:
          registry: us-central1-docker.pkg.dev
          username: oauth2accesstoken
          password: ${{ steps.gcp-auth.outputs.access_token }}

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and Push Docker Image for ${{ matrix.service }}
        uses: docker/build-push-action@v6
        env:
          ODIGOS_TAG: ${{ github.event_name == 'workflow_dispatch' && inputs.tag || steps.extract_tag.outputs.tag}}
        with:
          push: true
          provenance: false
          tags: |
            us-central1-docker.pkg.dev/odigos-cloud/components/odigos-${{ matrix.service }}${{ matrix.rhel == 'true' && '-rhel-certified' || '' }}:${{ env.ODIGOS_TAG }}
            keyval/odigos-${{ matrix.service }}${{ matrix.rhel == 'true' && '-rhel-certified' || '' }}:${{ env.ODIGOS_TAG }}
            ghcr.io/odigos-io/odigos-${{ matrix.service }}${{ matrix.rhel == 'true' && '-rhel-certified' || '' }}:${{ env.ODIGOS_TAG }}
          build-args: |
            SERVICE_NAME=${{ matrix.service }}
            ODIGOS_VERSION=${{ env.ODIGOS_TAG }}
            RELEASE=${{ env.ODIGOS_TAG }}
            VERSION=${{ env.ODIGOS_TAG }}
            SUMMARY=${{ matrix.summary }}
            DESCRIPTION=${{ matrix.description }}
            LD_FLAGS=-s -w
            RHEL=${{ matrix.rhel }}
            ODIGLET_MINIMAL=${{ matrix.service == 'odiglet-minimal' && 'true' || 'false' }}
          platforms: linux/amd64,linux/arm64
          file: >-
            ${{ matrix.service == 'odiglet' && 'odiglet/Dockerfile' ||
                matrix.service == 'odiglet-minimal' && 'odiglet/Dockerfile' ||
                matrix.service == 'collector' && 'collector/Dockerfile' ||
                matrix.service == 'ui' && 'frontend/Dockerfile' ||
                matrix.service == 'operator' && 'operator/Dockerfile' ||
                matrix.service == 'agents' && 'odiglet/Dockerfile' ||
                'Dockerfile' }}
          target: >-
            ${{ matrix.service == 'agents' && matrix.rhel == 'true' && 'agents-rhel' ||
                matrix.service == 'agents' && 'agents' ||
                matrix.rhel == 'true' && 'rhel' ||
                '' }}

      - name: Notify Slack
        if: always()
        uses: odigos-io/ci-core/.github/actions/slack-release-notification@main
        with:
          webhook-url: ${{ secrets.ODIGOS_RELEASE_STATUS_WEBHOOK_URL }}
          success-description: "Odigos component ${{ matrix.service }} with dockerfile ${{ matrix.dockerfile }} released successfully"
          failure-description: "ERROR: Odigos component ${{ matrix.service }} with dockerfile ${{ matrix.dockerfile }} release failed"
          tag: ${{ steps.extract_tag.outputs.tag }}

  publish-collector-linux-packages:
    if: ${{ needs.decide.outputs.skip != 'true' }}
    needs: decide
    permissions:
      contents: read
      id-token: write
    runs-on: depot-ubuntu-24.04-8
    steps:
      - name: Extract Tag
        id: extract_tag
        run: echo "tag=${GITHUB_REF#refs/*/}" >> $GITHUB_OUTPUT

      - name: Notify Slack Start
        if: always()
        uses: odigos-io/ci-core/.github/actions/slack-release-notification@main
        with:
          webhook-url: ${{ secrets.ODIGOS_RELEASE_STATUS_WEBHOOK_URL }}
          success-description: "start releasing odigos collector as linux packages"
          failure-description: "error during releasing of odigos collector as linux packages"
          tag: ${{ steps.extract_tag.outputs.tag }}

      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          ref: ${{ steps.extract_tag.outputs.tag }}

      - name: Determine repository (staging vs prod)
        id: determine_repo
        run: |
          TAG="${{ steps.extract_tag.outputs.tag }}"
          if [[ "$TAG" =~ -(rc|pre)[0-9]*$ ]]; then
            echo "repository=staging" >> $GITHUB_OUTPUT
            echo "Detected pre-release/RC tag: $TAG -> using staging repository"
          else
            echo "repository=odigos" >> $GITHUB_OUTPUT
            echo "Detected release tag: $TAG -> using production repository"
          fi

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: "1.25"

      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser
          version: latest
          args: release --clean
          workdir: collector

      - name: Upload Linux packages to Artifact Registry
        uses: odigos-io/ci-core/upload-linux-packages@v1.0.5
        with:
          gcp-project-id: ${{ secrets.GCP_PROJECT_ID }}
          gcp-workload-identity-provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          gcp-service-account: ${{ secrets.GCP_SERVICE_ACCOUNT }}
          package-directory: 'collector/dist'
          repository: ${{ steps.determine_repo.outputs.repository }}

      - name: Upload Linux Packages to AWS S3
        # Only upload real releases
        if: ${{ steps.determine_repo.outputs.repository == 'odigos' }}
        uses: odigos-io/ci-core/upload-to-s3@v1.0.6
        with:
          aws-role-arn: arn:aws:iam::061717858829:role/vmagent-s3
          aws-region: us-east-1
          bucket-name: odigos-releases
          agent-type: 'otelcol'
          version: ${{ steps.extract_tag.outputs.tag }}
          package-directory: 'collector/dist'

      - name: Notify Slack Success
        if: always()
        uses: odigos-io/ci-core/.github/actions/slack-release-notification@main
        with:
          webhook-url: ${{ secrets.ODIGOS_RELEASE_STATUS_WEBHOOK_URL }}
          success-description: "Odigos collector linux packages released successfully"
          failure-description: "ERROR: Odigos collector linux packages release failed"
          tag: ${{ steps.extract_tag.outputs.tag }}

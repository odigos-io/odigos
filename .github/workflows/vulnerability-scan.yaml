name: Vulnerability Scan
run-name: Vulnerability Scan (${{ inputs.tag }})

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Image tag to scan (e.g., v1.0.0)"
        required: true
        type: string

jobs:
  scan-images:
    name: Scan ${{ matrix.image }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        image:
          - odigos-autoscaler
          - odigos-scheduler
          - odigos-instrumentor
          - odigos-odiglet
          - odigos-collector
          - odigos-ui
          - odigos-operator
          - odigos-agents
    steps:
      - name: Pull image from registry
        run: |
          docker pull registry.odigos.io/${{ matrix.image }}:${{ inputs.tag }}

      - name: Scan image for vulnerabilities
        id: scan
        uses: odigos-io/ci-core/vulnerabilities-scanner@3ace0ddac40435dba0f98700af061f63c24442cd
        with:
          image: registry.odigos.io/${{ matrix.image }}:${{ inputs.tag }}
          severity-cutoff: "CRITICAL"
        continue-on-error: true

      - name: Save scan JSON results
        if: always()
        run: |
          mkdir -p /tmp/scan-results
          cat > /tmp/scan-results/${{ matrix.image }}.json << 'EOF'
          ${{ steps.scan.outputs.results-json }}
          EOF
          jq --arg img "${{ matrix.image }}" --arg tag "${{ inputs.tag }}" '. + {imageName: $img, imageTag: $tag}' /tmp/scan-results/${{ matrix.image }}.json > /tmp/scan-results/${{ matrix.image }}_enriched.json
          mv /tmp/scan-results/${{ matrix.image }}_enriched.json /tmp/scan-results/${{ matrix.image }}.json

      - name: Upload scan results JSON
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: vuln-scan-result-${{ matrix.image }}-${{ inputs.tag }}.json
          path: /tmp/scan-results/*.json
          retention-days: 30

  vulnerability-report:
    name: Generate Vulnerability Report
    needs: [scan-images]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Download all scan JSON results
        uses: actions/download-artifact@v4
        with:
          pattern: vuln-scan-result-*
          path: scan-results
          merge-multiple: true

      - name: Zip individual scan results
        run: |
          if [ -d "scan-results" ] && ls scan-results/*.json 1> /dev/null 2>&1; then
            zip -j scan-results.zip scan-results/*.json
            echo "Created zip with $(unzip -l scan-results.zip | grep -c '\.json') JSON files"
          else
            echo "No scan results to zip"
            touch scan-results.zip
          fi

      - name: Upload scan results
        uses: actions/upload-artifact@v4
        with:
          name: vulnerability-report
          path: scan-results.zip
          retention-days: 90

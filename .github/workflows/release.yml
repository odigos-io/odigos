name: Release Odigos

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag"
        required: true

  repository_dispatch:
    types: [release_cli]

permissions:
  contents: write
  packages: write
  id-token: 'write'

env:
  DOCKERHUB_ORG: "keyval"

jobs:
  package-helm:
    runs-on: ubuntu-latest
    steps:
      - name: Determine Tag Value
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "TAG=${{ github.event.inputs.tag }}" >> $GITHUB_ENV
          elif [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            echo "TAG=${{ github.event.client_payload.tag }}" >> $GITHUB_ENV
          else
            echo "Unknown event type"
            exit 1
          fi

      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          ref: ${{ env.TAG }} # checkout the tag we are releasing (main might have been updated since the tag was created)

      - name: Install Helm
        uses: azure/setup-helm@v4.2.0
        with:
          version: v3.15.2

      - name: Package Helm charts
        run: bash ./scripts/package-charts.sh

      - name: Upload packaged chart artifact
        uses: actions/upload-artifact@v4
        with:
          name: odigos-chart
          path: helm/odigos-*.tgz

      - name: Notify Slack
        uses: odigos-io/ci-core/.github/actions/slack-release-notification@main
        with:
          webhook-url: ${{ secrets.ODIGOS_RELEASE_STATUS_WEBHOOK_URL }}
          success-description: "Helm charts packaged successfully"
          failure-description: "ERROR: Failed to package Helm charts"
          tag: ${{ env.TAG }}

  build-cli:
    needs: package-helm
    runs-on: depot-ubuntu-24.04-8
    steps:
      - name: Determine Tag Value
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "TAG=${{ github.event.inputs.tag }}" >> $GITHUB_ENV
          elif [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            echo "TAG=${{ github.event.client_payload.tag }}" >> $GITHUB_ENV
          else
            echo "Unknown event type"
            exit 1
          fi

      - name: Check Release Type
        run: |
          TAG="${{ env.TAG }}"

          # Check if it's a pre-release (has additional suffix after vX.Y.Z)
          if [[ "$TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+- ]]; then
            echo "IS_PRERELEASE=true" >> $GITHUB_ENV
            echo "This is a pre-release: $TAG"
          else
            echo "IS_PRERELEASE=false" >> $GITHUB_ENV
            echo "This is a stable release: $TAG"
          fi

      - uses: actions/checkout@v5
        with:
          fetch-depth: 0
          ref: ${{ env.TAG }} # checkout the tag we are releasing (main might have been updated since the tag was created)

      # Ensure the chart is here to be embedded in the CLI
      - name: Download packaged chart artifact
        uses: actions/download-artifact@v4
        with:
          name: odigos-chart
          path: cli/pkg/helm/embedded

      - name: Set env
        id: vars
        run: |
          SHORT_COMMIT=$(git rev-parse --short HEAD)
          echo "short_commit=${SHORT_COMMIT}" >> $GITHUB_ENV
          echo "date=$(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> $GITHUB_OUTPUT

      - name: Notify Slack Start
        uses: odigos-io/ci-core/.github/actions/slack-release-notification@main
        with:
          webhook-url: ${{ secrets.ODIGOS_RELEASE_STATUS_WEBHOOK_URL }}
          success-description: "Starting Odigos CLI release for tag ${{ env.TAG }}"
          failure-description: "ERROR: Failed to start Odigos CLI release"
          tag: ${{ env.TAG }}

      - name: Verify Components Image Ready
        run: |
          declare -a REPOS=("odigos-autoscaler" "odigos-scheduler" "odigos-instrumentor" "odigos-odiglet" "odigos-odiglet-minimal" "odigos-collector" "odigos-enterprise-odiglet" "odigos-ui" "odigos-enterprise-instrumentor" "odigos-operator" "odigos-enterprise-agents" "odigos-enterprise-central-backend" "odigos-enterprise-central-proxy" "odigos-enterprise-central-ui")
          for repo in "${REPOS[@]}"; do
            REPOS+=("${repo}-rhel-certified")
          done

          TAG_TO_CHECK=${{ env.TAG }}

          for REPO in "${REPOS[@]}"; do
            echo "Checking tag $TAG_TO_CHECK in $REPO..."
            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
            "https://artifactregistry.us-central1.rep.googleapis.com/v1/projects/odigos-cloud/locations/us-central1/repositories/components/packages/$REPO/tags/$TAG_TO_CHECK")

            if [ "$HTTP_STATUS" -eq 200 ]; then
              echo "Tag $TAG_TO_CHECK exists in $REPO."
            else
              echo "Tag $TAG_TO_CHECK does NOT exist in $REPO. HTTP status: $HTTP_STATUS"
              exit 1
            fi
          done

      - id: gcp-auth
        name: Authenticate with Google Cloud
        uses: google-github-actions/auth@v3
        with:
          token_format: 'access_token'
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}
          access_token_lifetime: 1200s

      - name: Login to Artifact Registry
        uses: docker/login-action@v3
        with:
          registry: us-central1-docker.pkg.dev
          username: oauth2accesstoken
          password: ${{ steps.gcp-auth.outputs.access_token }}

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - uses: actions/setup-go@v6
        with:
          go-version: "1.25"

      - uses: actions/setup-node@v5
        with:
          node-version: 18

      - uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser
          version: latest
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          HOMEBREW_GITHUB_API_TOKEN: ${{ secrets.HOMEBREW_GITHUB_API_TOKEN }}
          IS_PRERELEASE: ${{ env.IS_PRERELEASE }}
          GORELEASER_CURRENT_TAG: ${{ env.TAG }}

      - uses: ko-build/setup-ko@v0.9

      - name: publish cli image to docker registries
        working-directory: ./cli
        env:
          KO_DOCKER_REPO: us-central1-docker.pkg.dev/odigos-cloud/components/odigos-cli
          KO_CONFIG_PATH: ./.ko.yaml
          VERSION: ${{ env.TAG }}
          SHORT_COMMIT: ${{ steps.vars.outputs.short_commit }}
          DATE: ${{ steps.vars.outputs.date }}
        run: |
          ko build --bare --tags latest --tags ${{ env.TAG }} --platform=linux/amd64,linux/arm64

      - name: publish cli certified image to GCR registry
        working-directory: ./cli
        env:
          KO_DOCKER_REPO: us-central1-docker.pkg.dev/odigos-cloud/components/odigos-cli-rhel-certified
          KO_CONFIG_PATH: ./.ko.yaml
          VERSION: ${{ env.TAG }}
          SHORT_COMMIT: ${{ steps.vars.outputs.short_commit }}
          DATE: ${{ steps.vars.outputs.date }}
          KO_DEFAULTBASEIMAGE: registry.access.redhat.com/ubi9/ubi-micro:latest
        run: |
          ko build --bare --tags latest --tags ${{ env.TAG }} \
          --image-label name=odigos-cli \
          --image-label vendor=Odigos \
          --image-label maintainer=Odigos \
          --image-label version=${{ env.TAG }} \
          --image-label release=${{ env.TAG }} \
          --image-label summary="Odigos CLI" \
          --image-label description="Odigos CLI to install and manage Odigos in your Kubernetes cluster." \
          --platform=all .

      - name: Install crane
        uses: imjasonh/setup-crane@v0.4

      - name: Copy CLI image to Docker Hub
        env:
          SOURCE_IMAGE: us-central1-docker.pkg.dev/odigos-cloud/components/odigos-cli
          DEST_IMAGE: ${{ env.DOCKERHUB_ORG }}/odigos-cli
        run: |
          crane copy ${SOURCE_IMAGE}:${{ env.TAG }} ${DEST_IMAGE}:${{ env.TAG }}
          crane copy ${SOURCE_IMAGE}:latest ${DEST_IMAGE}:latest

      - name: Set notification messages
        run: |
          if [ "${{ env.IS_PRERELEASE }}" = "false" ]; then
            echo "SUCCESS_MSG=Odigos CLI stable release completed successfully" >> $GITHUB_ENV
            echo "FAILURE_MSG=ERROR: Failed to publish Odigos CLI image to registries" >> $GITHUB_ENV
          else
            echo "SUCCESS_MSG=Odigos CLI pre-release completed successfully" >> $GITHUB_ENV
            echo "FAILURE_MSG=ERROR: Failed to publish Odigos CLI image to registries" >> $GITHUB_ENV
          fi

      - name: Notify Slack
        uses: odigos-io/ci-core/.github/actions/slack-release-notification@main
        with:
          webhook-url: ${{ secrets.ODIGOS_RELEASE_STATUS_WEBHOOK_URL }}
          success-description: ${{ env.SUCCESS_MSG }}
          failure-description: ${{ env.FAILURE_MSG }}
          tag: ${{ env.TAG }}

  publish-helm:
    needs: build-cli
    runs-on: ubuntu-latest
    steps:
      - name: Determine Tag Value
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "TAG=${{ github.event.inputs.tag }}" >> $GITHUB_ENV
          elif [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            echo "TAG=${{ github.event.client_payload.tag }}" >> $GITHUB_ENV
          else
            echo "Unknown event type"
            exit 1
          fi

      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          ref: ${{ env.TAG }} # checkout the tag we are releasing (main might have been updated since the tag was created)

      - name: Configure Git
        run: |
          git config --global user.email "bot@odigos.io"
          git config --global user.name "Odigos Release Bot"

      - name: Install Helm
        uses: azure/setup-helm@v4.2.0
        with:
          version: v3.15.2

      - name: Download packaged chart artifact
        uses: actions/download-artifact@v4
        with:
          name: odigos-chart
          path: helm/

      - name: Publish Helm charts
        env:
          GH_TOKEN: ${{ secrets.RELEASE_BOT_TOKEN }}
        run: bash ./scripts/publish-charts.sh

      - name: Notify Slack
        uses: odigos-io/ci-core/.github/actions/slack-release-notification@main
        with:
          webhook-url: ${{ secrets.ODIGOS_RELEASE_STATUS_WEBHOOK_URL }}
          success-description: "Helm charts published successfully. new version is ready"
          failure-description: "ERROR: Failed to publish Helm charts"
          tag: ${{ env.TAG }}

  trigger-openshift-certification:
    needs: publish-helm
    runs-on: ubuntu-latest
    steps:
      - name: Determine Tag Value
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "TAG=${{ github.event.inputs.tag }}" >> $GITHUB_ENV
          elif [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            echo "TAG=${{ github.event.client_payload.tag }}" >> $GITHUB_ENV
          else
            echo "Unknown event type"
            exit 1
          fi

      - name: Trigger OpenShift Preflight job
        run: |
          curl -X POST \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: token ${{ secrets.RELEASE_BOT_TOKEN }}" \
            https://api.github.com/repos/odigos-io/odigos/dispatches \
            -d '{"event_type": "openshift_preflight", "client_payload": {"tag": "${{ env.TAG }}"}}'

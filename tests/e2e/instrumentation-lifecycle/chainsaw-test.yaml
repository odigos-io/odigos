apiVersion: chainsaw.kyverno.io/v1alpha1
kind: Test
metadata:
  name: instrumentation-lifecycle
spec:
  description: |
    This e2e test verifies the instrumentation device injection and instance lifecycle management.
    It tests that supported workloads get properly instrumented and that the instrumentation
    instances are created with correct health status.
  skipDelete: true
  steps:
    - name: Prepare destination
      try:
        - apply:
            file: ../../common/apply/simple-trace-db-deployment.yaml

    - name: Install Test Apps
      try:
        - apply:
            file: install-test-apps.yaml

    - name: Install Odigos
      try:
        - script:
            content: |
              ../../../cli/odigos install --ns odigos-test --set image.tag=e2e-test
              ../../common/verify_odigos_installation.sh odigos-test
              kubectl label namespace odigos-test odigos.io/system-object="true"
            timeout: 4m
        - assert:
            timeout: 3m
            file: ../../common/assert/odigos-installed.yaml

    - name: Verify Node Odiglet label has been added
      try:
        - assert:
            file: ../../common/assert/node-odiglet-label.yaml

    - name: Assert Trace DB is up
      try:
        - assert:
            timeout: 1m
            file: ../../common/assert/simple-trace-db-running.yaml

    - name: Assert Apps installed
      try:
        - assert:
            timeout: 5m
            file: ../../common/assert/instrumentation-apps-ready.yaml

    - name: Instrument Namespaces
      try:
        - apply:
            file: ../../common/apply/instrument-default-ns.yaml

    - name: Add Destination
      try:
        - apply:
            file: ../../common/apply/add-simple-trace-db-destination.yaml

    - name: Assert Pipeline
      try:
        - assert:
            timeout: 1m
            file: ../../common/assert/pipeline-ready.yaml

    - name: Assert Instrumentation Lifecycle
      try:
        - assert:
            timeout: 3m
            file: assert-instrumented.yaml

    - name: Assert Workload State Changes
      try:
        - assert:
            timeout: 1m
            file: assert-workloads.yaml

    - name: Assert Instrumentation Instances Created
      try:
        - assert:
            timeout: 1m
            file: assert-instances.yaml

    - name: Assert Workload Rollouts Completed
      try:
        - assert:
            timeout: 1m
            file: assert-rollouts.yaml

    ############# Rate Limiting Test #############
    # Test that rollout rate limiting works by:
    # 1. Enabling rate limiting with concurrentRollouts=2
    # 2. Uninstrumenting all workloads
    # 3. Re-instrumenting and verifying some workloads are queued

    # NOTE: we might see flakiness in the CI due to the rate limiting. If we see it, we can decrease the concurrentRollouts to 1.
    - name: Enable Rollout Rate Limiting
      try:
        - script:
            timeout: 30s
            content: |
              ../../../cli/odigos upgrade --ns odigos-test \
                --set rollout.isConcurrentRolloutsLimiterEnabled=true \
                --set rollout.concurrentRollouts=2

    - name: Assert Rate Limiting Config Applied
      try:
        - script:
            timeout: 30s
            content: |
              config=$(kubectl get odigosconfigurations.odigos.io -n odigos-test odigos -o jsonpath='{.spec.rollout}')
              echo "Rollout config: $config"
              echo "$config" | grep -q '"isConcurrentRolloutsLimiterEnabled":true' || exit 1
              echo "$config" | grep -q '"concurrentRollouts":2' || exit 1
              echo "Rate limiting config verified"

    - name: Uninstrument Namespace
      try:
        - delete:
            file: ../../common/apply/instrument-default-ns.yaml

    - name: Wait for InstrumentationConfigs Deleted
      try:
        - script:
            timeout: 2m
            content: |
              while true; do
                count=$(kubectl get instrumentationconfigs -n default --no-headers 2>/dev/null | wc -l)
                if [ "$count" -eq "0" ]; then
                  echo "All InstrumentationConfigs deleted"
                  break
                fi
                echo "Waiting for InstrumentationConfigs to be deleted... ($count remaining)"
                sleep 2
              done

    - name: Assert Workloads Uninstrumented
      try:
        - assert:
            timeout: 2m
            file: assert-uninstrumented-rollouts.yaml

    - name: Re-instrument Namespace
      try:
        - apply:
            file: ../../common/apply/instrument-default-ns.yaml

    - name: Assert Some Workloads Waiting In Queue
      try:
        - script:
            timeout: 30s
            content: |
              # Wait briefly for instrumentation to start
              sleep 3
              # Check that at least one workload has WaitingInQueue condition
              # With 4 workloads and limit of 2, at least 2 should be queued initially
              for i in $(seq 1 10); do
                waiting=$(kubectl get instrumentationconfigs -n default -o json | \
                  jq '[.items[].status.conditions[]? | select(.type=="WorkloadRollout" and .reason=="WaitingInQueue")] | length')
                if [ "$waiting" -ge "1" ]; then
                  echo "Found $waiting workload(s) waiting in queue - rate limiting is working!"
                  exit 0
                fi
                echo "Attempt $i: No workloads in queue yet, checking again..."
                sleep 1
              done
              echo "Warning: Could not verify WaitingInQueue condition (workloads may have rolled out too fast)"
              # Don't fail - the rate limiter might have processed them quickly
              exit 0

    - name: Assert All Rollouts Eventually Complete
      try:
        - assert:
            timeout: 3m
            file: assert-rate-limited-rollouts-complete.yaml

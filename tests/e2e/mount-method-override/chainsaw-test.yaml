apiVersion: chainsaw.kyverno.io/v1alpha1
kind: Test
metadata:
  name: mount-method-override
spec:
  description: >
    Tests the mount method override mechanisms (namespace annotation and node label).
    Odigos is installed with the default mount method (k8s-virtual-device), then
    overrides are applied to verify the webhook auto-switches to k8s-init-container.
  skipDelete: true
  steps:
    ########################################################################
    # Phase 1: Setup - Install Odigos with DEFAULT mount method, deploy apps
    ########################################################################

    - name: "[1 - Setup] Install - Simple Demo Apps"
      try:
        - apply:
            file: ../../common/apply/install-simple-demo.yaml

    - name: "[1 - Setup] Prepare destination"
      try:
        - apply:
            file: ../../common/apply/simple-trace-db-deployment.yaml

    - name: "[1 - Setup] Install Odigos with default settings (virtual-device)"
      try:
        - script:
            timeout: 4m
            content: |
              if [ "$MODE" = "cross-cloud-tests" ]; then
                ../../../cli/odigos install --ns odigos-test --set image.tag="$COMMIT_HASH" --set imagePrefix=public.ecr.aws/y2v0v6s7
              else
                ../../../cli/odigos install --ns odigos-test --set image.tag=e2e-test
              fi
              kubectl label namespace odigos-test odigos.io/system-object="true"
              ../../common/verify_odigos_installation.sh odigos-test
        - assert:
            timeout: 3m
            file: ../../common/assert/odigos-installed.yaml

    - name: "[1 - Setup] Assert - Simple Demo Apps Installed"
      try:
        - assert:
            timeout: 3m
            file: ../../common/assert/simple-demo-installed.yaml

    - name: "[1 - Setup] Assert Trace DB is up"
      try:
        - assert:
            timeout: 1m
            file: ../../common/assert/simple-trace-db-running.yaml

    - name: "[1 - Setup] Add Destination"
      try:
        - apply:
            file: ../../common/apply/add-simple-trace-db-destination.yaml

    ########################################################################
    # Phase 2: Namespace annotation override
    # Apply the odigos.io/mount-method annotation to the default namespace
    # and verify the webhook switches to init-container mount method.
    ########################################################################

    - name: "[2 - NS Override] Annotate namespace with mount method override"
      try:
        - script:
            timeout: 30s
            content: |
              kubectl annotate namespace default odigos.io/mount-method=k8s-init-container --overwrite
              echo "Namespace annotation applied:"
              kubectl get namespace default -o jsonpath='{.metadata.annotations}' | jq .

    - name: "[2 - NS Override] Instrument default namespace"
      try:
        - apply:
            file: ../../common/apply/instrument-default-ns.yaml

    - name: "[2 - NS Override] Assert Runtime Detected"
      try:
        - assert:
            timeout: 3m
            file: ../../common/assert/simple-demo-runtime-detected.yaml

    - name: "[2 - NS Override] Odigos pipeline ready"
      try:
        - assert:
            timeout: 1m
            file: ../../common/assert/pipeline-ready.yaml

    - name: "[2 - NS Override] Wait for instrumentation to be active"
      try:
        - assert:
            file: ../../common/assert/simple-demo-instrumented.yaml
        - script:
            timeout: 2m
            content: ../../common/wait_for_rollout.sh

    - name: "[2 - NS Override] Verify init container was used (namespace annotation override)"
      try:
        - script:
            timeout: 2m
            content: |
              echo "=== Verifying namespace annotation override ==="
              echo "Checking that pods use init-container mount method..."

              # Check that at least one pod has the odigos-agents init container
              INIT_PODS=$(kubectl get pods -n default -o jsonpath='{range .items[*]}{.metadata.name}{" initContainers: "}{range .spec.initContainers[*]}{.name}{" "}{end}{"\n"}{end}' | grep "odigos-agents" | wc -l)
              if [ "$INIT_PODS" -eq 0 ]; then
                echo "FAIL: No pods found with odigos-agents init container"
                kubectl get pods -n default -o yaml
                exit 1
              fi
              echo "Found $INIT_PODS pods with odigos-agents init container"

              # Verify emptyDir volume is used (not hostPath)
              EMPTY_DIR_PODS=$(kubectl get pods -n default -o jsonpath='{range .items[*]}{.metadata.name}{" "}{range .spec.volumes[*]}{.name}{"="}{.emptyDir}{" "}{end}{"\n"}{end}' | grep "odigos-agent={}" | wc -l)
              if [ "$EMPTY_DIR_PODS" -eq 0 ]; then
                echo "FAIL: No pods found with emptyDir volume for odigos-agent"
                exit 1
              fi
              echo "Found $EMPTY_DIR_PODS pods with emptyDir volume"

              # Verify NO hostPath volumes are used for odigos
              HOST_PATH_PODS=$(kubectl get pods -n default -o json | jq '[.items[].spec.volumes[]? | select(.name == "odigos-agent" and .hostPath != null)] | length')
              if [ "$HOST_PATH_PODS" -ne 0 ]; then
                echo "FAIL: Found pods with hostPath volume for odigos-agent"
                exit 1
              fi
              echo "Namespace annotation override verification PASSED"
      catch:
        - script:
            content: |
              echo "=== Pod details ==="
              kubectl get pods -n default -o wide
              echo "=== Pod specs (volumes) ==="
              kubectl get pods -n default -o jsonpath='{range .items[*]}{"Pod: "}{.metadata.name}{"\n  volumes: "}{range .spec.volumes[*]}{.name}{" "}{end}{"\n  initContainers: "}{range .spec.initContainers[*]}{.name}{" "}{end}{"\n"}{end}'
              echo "=== Instrumentor logs ==="
              kubectl logs -n odigos-test -l app.kubernetes.io/name=odigos-instrumentor --tail=100

    - name: "[2 - NS Override] Generate Traffic"
      try:
        - apply:
            file: ../../common/apply/generate-traffic-job.yaml
        - script:
            timeout: 1m
            content: |
              kubectl wait --for=condition=complete job/$(kubectl get -f ../../common/apply/generate-traffic-job.yaml -o=jsonpath='{.metadata.name}')
        - delete:
            file: ../../common/apply/generate-traffic-job.yaml

    - name: "[2 - NS Override] Wait For Trace"
      try:
        - script:
            timeout: 1m
            content: |
              while true; do
                ../../common/simple_trace_db_query_runner.sh ../../common/queries/wait-for-trace.yaml
                if [ $? -eq 0 ]; then
                  break
                fi
                sleep 1
              done
      catch:
        - script:
            content: |
              java_pod_name=$(kubectl get pods -n default -o jsonpath="{.items[*].metadata.name}" | tr ' ' '\n' | grep ^frontend)
              kubectl logs $java_pod_name -n default

    - name: "[2 - NS Override] Verify Trace - Context Propagation"
      try:
        - script:
            timeout: 3m
            content: |
              ../../common/simple_trace_db_query_runner.sh ../../common/queries/context-propagation.yaml
      catch:
        - podLogs:
            name: odiglet
            namespace: odigos-test

    ########################################################################
    # Phase 3: Node label override
    # Remove the namespace annotation, apply the node label instead,
    # restart workloads, and verify init-container is still used.
    ########################################################################

    - name: "[3 - Node Override] Remove namespace annotation and apply node label"
      try:
        - script:
            timeout: 30s
            content: |
              # Remove namespace annotation so only the node label drives the override
              kubectl annotate namespace default odigos.io/mount-method- --overwrite
              echo "Namespace annotation removed"

              # Label the kind node(s) to simulate Bottlerocket auto-detection
              for node in $(kubectl get nodes -o jsonpath='{.items[*].metadata.name}'); do
                kubectl label node "$node" odigos.io/mount-method-override=k8s-init-container --overwrite
                echo "Labeled node $node with mount-method-override"
              done

    - name: "[3 - Node Override] Restart workloads to trigger re-injection"
      try:
        - script:
            timeout: 3m
            content: |
              # Restart deployments so the webhook re-evaluates mount method
              kubectl rollout restart deployment -n default -l odigos.io/e2e=source
              ../../common/wait_for_rollout.sh

    - name: "[3 - Node Override] Verify init container was used (node label override)"
      try:
        - script:
            timeout: 2m
            content: |
              echo "=== Verifying node label override ==="

              # Check that at least one pod has the odigos-agents init container
              INIT_PODS=$(kubectl get pods -n default -o jsonpath='{range .items[*]}{.metadata.name}{" initContainers: "}{range .spec.initContainers[*]}{.name}{" "}{end}{"\n"}{end}' | grep "odigos-agents" | wc -l)
              if [ "$INIT_PODS" -eq 0 ]; then
                echo "FAIL: No pods found with odigos-agents init container after node label override"
                kubectl get pods -n default -o yaml
                exit 1
              fi
              echo "Found $INIT_PODS pods with odigos-agents init container"

              # Verify emptyDir volume is used
              EMPTY_DIR_PODS=$(kubectl get pods -n default -o jsonpath='{range .items[*]}{.metadata.name}{" "}{range .spec.volumes[*]}{.name}{"="}{.emptyDir}{" "}{end}{"\n"}{end}' | grep "odigos-agent={}" | wc -l)
              if [ "$EMPTY_DIR_PODS" -eq 0 ]; then
                echo "FAIL: No pods found with emptyDir volume for odigos-agent"
                exit 1
              fi
              echo "Found $EMPTY_DIR_PODS pods with emptyDir volume"
              echo "Node label override verification PASSED"
      catch:
        - script:
            content: |
              echo "=== Node labels ==="
              kubectl get nodes --show-labels
              echo "=== Pod details ==="
              kubectl get pods -n default -o wide
              echo "=== Instrumentor logs ==="
              kubectl logs -n odigos-test -l app.kubernetes.io/name=odigos-instrumentor --tail=100

    - name: "[3 - Node Override] Generate Traffic"
      try:
        - apply:
            file: ../../common/apply/generate-traffic-job.yaml
        - script:
            timeout: 1m
            content: |
              kubectl wait --for=condition=complete job/$(kubectl get -f ../../common/apply/generate-traffic-job.yaml -o=jsonpath='{.metadata.name}')
        - delete:
            file: ../../common/apply/generate-traffic-job.yaml

    - name: "[3 - Node Override] Wait For Trace"
      try:
        - script:
            timeout: 1m
            content: |
              while true; do
                ../../common/simple_trace_db_query_runner.sh ../../common/queries/wait-for-trace.yaml
                if [ $? -eq 0 ]; then
                  break
                fi
                sleep 1
              done

    - name: "[3 - Node Override] Verify Trace - Context Propagation"
      try:
        - script:
            timeout: 3m
            content: |
              ../../common/simple_trace_db_query_runner.sh ../../common/queries/context-propagation.yaml
      catch:
        - podLogs:
            name: odiglet
            namespace: odigos-test

    ########################################################################
    # Cleanup
    ########################################################################

    - name: "Cleanup - Remove overrides"
      try:
        - script:
            timeout: 30s
            content: |
              # Remove node labels
              for node in $(kubectl get nodes -o jsonpath='{.items[*].metadata.name}'); do
                kubectl label node "$node" odigos.io/mount-method-override- || true
              done
              # Remove namespace annotation (in case it's still there)
              kubectl annotate namespace default odigos.io/mount-method- || true
              echo "Override labels and annotations cleaned up"

    - name: "Uninstall Odigos"
      try:
        - script:
            timeout: 2m
            content: ../../../cli/odigos uninstall --ns odigos-test
        - script:
            timeout: 1m
            content: |
              for i in $(seq 1 10); do
                if ../../common/assert_odigos_uninstalled.sh; then
                  exit 0
                fi
                echo "Attempt $i: Odigos uninstallation verification failed, retrying in 5 seconds..."
                sleep 5
              done

              echo "Failed to verify Odigos uninstallation after 10 attempts"
              exit 1

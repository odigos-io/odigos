apiVersion: chainsaw.kyverno.io/v1alpha1
kind: Test
metadata:
  name: ui-cypress
spec:
  description: Run E2E tests against Odigos UI using Cypress
  skipDelete: true
  steps:
    - name: Install Odigos
      try:
        - script:
            content: |
              ../../../cli/odigos install --namespace odigos-test --version e2e-test
            timeout: 60s
        - assert:
            file: ../../common/assert/odigos-installed.yaml

    - name: Install Demo App
      try:
        - apply:
            file: ../../common/apply/install-simple-demo.yaml
        - script:
            timeout: 60s
            content: |
              kubectl wait --for=condition=ready pod -l app=frontend --timeout=60s
              kubectl wait --for=condition=ready pod -l app=coupon --timeout=60s
              kubectl wait --for=condition=ready pod -l app=inventory --timeout=60s
              kubectl wait --for=condition=ready pod -l app=pricing --timeout=60s
              kubectl wait --for=condition=ready pod -l app=membership --timeout=60s
        - assert:
            file: ../../common/assert/simple-demo-installed.yaml

    - name: Instrument Namespace
      try:
        - apply:
            file: ../../common/apply/instrument-default-ns.yaml

    - name: Assert Runtime Detected
      try:
        - assert:
            timeout: 120s
            file: ../../common/assert/simple-demo-runtime-detected.yaml

    - name: Prepare destination
      try:
        - script:
            timeout: 60s
            content: |
              if helm status e2e-tests -n traces >/dev/null 2>&1; then
                echo "e2e-tests helm already installed, probably from previous run. Skipping..."
              else
                helm repo add grafana https://grafana.github.io/helm-charts
                helm repo update
                helm install e2e-tests grafana/tempo -n traces --create-namespace --set tempo.storage.trace.block.version=vParquet4 \
                --set tempo.ingester.trace_idle_period=5s \
                --set tempo.ingester.max_block_duration=20s \
                --version 1.10.1
              fi
        - assert:
            file: ../../common/assert/tempo-running.yaml

    - name: Wait for destination to be ready
      try:
        - script:
            timeout: 60s
            content: ../../common/wait_for_dest.sh

    - name: Add Destination
      try:
        - apply:
            file: ../../common/apply/add-tempo-traces-destination.yaml

    - name: Odigos pipeline ready
      try:
        - assert:
            file: ../../common/assert/pipeline-ready.yaml

    - name: Simple-demo instrumented after destination added
      try:
        - assert:
            file: ../../common/assert/simple-demo-instrumented.yaml

    - name: Start Odigos UI
      try:
        - script:
            timeout: 30s
            content: |
              nohup ../../../cli/odigos ui --beta > odigos-ui.log 2>&1 &
              sleep 5

    - name: Wait for Odigos UI
      try:
        - script:
            timeout: 30s
            content: |
              for i in {1..10}; do
                curl -s http://localhost:3000 && break || sleep 2
              done

    - name: Install Cypress
      try:
        - script:
            timeout: 120s
            content: |
              cd ../../../frontend/webapp
              yarn install

    - name: Start Cypress tests
      try:
        - script:
            timeout: 300s
            content: |
              cd ../../../frontend/webapp
              yarn cy:run

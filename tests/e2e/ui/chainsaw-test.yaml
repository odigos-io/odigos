apiVersion: chainsaw.kyverno.io/v1alpha1
kind: Test
metadata:
  name: ui
spec:
  description: Run E2E tests against Odigos UI using Cypress
  skipDelete: true
  steps:
    - name: Install Odigos
      try:
        - script:
            timeout: 60s
            content: |
              ../../../cli/odigos install --version e2e-test

    - name: Install App - Simple Demo
      try:
        - script:
            timeout: 300s
            content: |
              kubectl apply -f https://raw.githubusercontent.com/odigos-io/simple-demo/main/kubernetes/deployment.yaml
              kubectl wait --for=condition=available --timeout=300s deployment --all -n default

    - name: Add Destination - Jaeger
      try:
        - script:
            timeout: 300s
            content: |
              kubectl apply -f https://raw.githubusercontent.com/odigos-io/simple-demo/main/kubernetes/jaeger.yaml
              kubectl wait --for=condition=available --timeout=60s deployment/jaeger -n tracing

    - name: Start UI
      try:
        - script:
            timeout: 10s
            content: |
              nohup ../../../cli/odigos ui --beta &
              sleep 5

    - name: Install dependencies
      try:
        - script:
            timeout: 60s
            content: |
              cd ../../../frontend/webapp
              yarn install

    - name: Start Cypress tests
      try:
        - script:
            timeout: 300s
            content: |
              cd ../../../frontend/webapp
              yarn cy:run

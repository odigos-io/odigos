apiVersion: chainsaw.kyverno.io/v1alpha1
kind: Test
metadata:
  name: helm-upgrade
spec:
  description: Check successful upgrade from latest version of Helm chart
  skipDelete: true
  steps:
    - name: Prepare destination
      try:
        - apply:
            file: ../../common/apply/simple-trace-db-deployment.yaml

    - name: Install - Simple Demo Apps
      try:
        - apply:
            file: ../../common/apply/install-simple-demo.yaml

    - name: Install Odigos latest release from GitHub for pre upgrade setup
      try:
        - script:
            timeout: 6m # longer timeout since the images are being pulled from dockerhub
            content: |
              #!/bin/bash

              # Define variables
              REPO_URL="https://api.github.com/repos/odigos-io/odigos/releases"

              # Fetch all releases from GitHub API with retry
              # --retry 5: retry up to 5 times
              # --retry-delay 1: wait 1 second between retries
              # --retry-max-time 30: maximum time to spend retrying (30 seconds)
              RELEASES_JSON=$(curl -s --retry 5 --retry-delay 1 --retry-max-time 30 "$REPO_URL")

              # Find the latest non-RC release by semantic version
              # Filter out RC/prerelease/draft releases, then sort by semantic version and take the latest
              LATEST_RELEASE_JSON=$(echo "$RELEASES_JSON" | jq -r '
                [.[] | select(.tag_name | test("rc"; "i") | not) | select(.prerelease == false) | select(.draft == false)] |
                sort_by(.tag_name | sub("^v"; "") | split(".") | map(tonumber)) |
                reverse |
                .[0]
              ')

              # Check if we found a valid release
              if [ "$LATEST_RELEASE_JSON" = "null" ] || [ -z "$LATEST_RELEASE_JSON" ]; then
                  echo "No valid non-RC release found"
                  exit 1
              fi

              # Extract the tag name for logging
              TAG_NAME=$(echo "$LATEST_RELEASE_JSON" | jq -r '.tag_name')
              echo "Found latest non-RC release: $TAG_NAME"

              # Find the download URL for the BASE odigos helm chart
              CHART_DOWNLOAD_URL=$(echo "$LATEST_RELEASE_JSON" | jq -r '.assets[] | select(.name | test("helm-chart-odigos-[0-9]")) | .browser_download_url')

              # Check if the download URL was found
              if [ -z "$CHART_DOWNLOAD_URL" ] || [ "$CHART_DOWNLOAD_URL" = "null" ]; then
                  echo "No matching helm chart found in release $TAG_NAME"
                  echo "Available assets for release $TAG_NAME:"
                  echo "$LATEST_RELEASE_JSON" | jq -r '.assets[].name'
                  exit 1
              fi

              echo "Downloading Helm chart from: $CHART_DOWNLOAD_URL"

              # Download the helm chart with retry
              # --retry 5: retry up to 5 times
              # --retry-delay 1: wait 1 second between retries
              # --retry-max-time 60: maximum time to spend retrying (60 seconds for download)
              curl -L -o odigos-latest-chart.tgz --retry 5 --retry-delay 1 --retry-max-time 60 "$CHART_DOWNLOAD_URL"

              # Cleanup any existing installation that might be left over from previous runs
              helm uninstall odigos -n odigos-test || true

              # Install the latest version from the downloaded chart
              helm upgrade --install odigos ./odigos-latest-chart.tgz \
                --create-namespace \
                --namespace odigos-test \
                --set nodeSelector."kubernetes\.io/os"=linux

              kubectl label namespace odigos-test odigos.io/system-object="true"
        - assert:
            timeout: 4m
            file: ../../common/assert/latest-odigos-version-installed.yaml

    - name: Assert Trace DB is up
      try:
        - assert:
            timeout: 1m
            file: ../../common/assert/simple-trace-db-running.yaml

    - name: Assert - Simple Demo Apps Installed
      try:
        - assert:
            timeout: 3m
            file: ../../common/assert/simple-demo-installed.yaml

    - name: Instrument Namespace
      try:
        - apply:
            file: ../../common/apply/instrument-default-ns.yaml

    - name: Assert Runtime Detected
      try:
        - assert:
            timeout: 3m
            file: ../../common/assert/simple-demo-runtime-detected.yaml

    - name: Add Destination
      try:
        - apply:
            file: ../../common/apply/add-simple-trace-db-destination.yaml

    - name: Odigos pipeline pods ready
      # We make sure that the pipeline pods are ready before proceeding with the next steps
      # This is intentionally different from pipeline-ready.yaml, which checks for the pipeline CRDs
      # When adding a feature related to the pipeline, if we would use the same assert before the upgrade, the test would fail.
      # Since the version installed here is latest official one.
      try:
        - script:
            content: ../../common/assert_pipeline_pods_ready.sh
            timeout: 5m

    - name: Simple-demo instrumented after destination added
      try:
        - assert:
            file: ../../common/assert/simple-demo-instrumented.yaml

    - name: Upgrade to HEAD version with local Helm chart
      try:
        - script:
            content: |
              # The pwd is the directory of this file, so we have to walk up to the project root to find the helm chart
              P="../../.."
              if [ "$MODE" = "cross-cloud-tests" ]; then
                helm upgrade odigos $P/helm/odigos \
                  --namespace odigos-test \
                  --set image.tag="$COMMIT_HASH" \
                  --set imagePrefix=public.ecr.aws/y2v0v6s7 \
                  --set nodeSelector."kubernetes\.io/os"=linux
              else
                helm upgrade odigos $P/helm/odigos \
                  --namespace odigos-test \
                  --set image.tag=e2e-test \
                  --set nodeSelector."kubernetes\.io/os"=linux
              fi
            timeout: 5m
        - assert:
            file: ../../common/assert/odigos-upgraded.yaml
            timeout: 5m
      catch:
        - get:
            apiVersion: v1
            kind: Pod

    - name: Verify Helm upgrade version
      try:
        - script:
            timeout: 2m
            content: |
              echo "Starting Odigos version check after upgrade..."
              export ACTUAL_VERSION=$(../../../cli/odigos version --cluster)
              echo "Actual Version: $ACTUAL_VERSION"
              echo "Commit Hash: $COMMIT_HASH"

              if [ "$MODE" = "cross-cloud-tests" ]; then
                if [ "$ACTUAL_VERSION" != "$COMMIT_HASH" ]; then
                  echo "❌ Odigos version is not the expected commit hash, got $ACTUAL_VERSION"
                  exit 1
                fi
              else
                if [ "$ACTUAL_VERSION" != "e2e-test" ]; then
                  echo "❌ Odigos version is not e2e-test, got $ACTUAL_VERSION"
                  exit 1
                fi
              fi
              echo "✅ Odigos version verification passed"

    - name: Odigos pipeline ready after upgrade
      try:
        - assert:
            timeout: 1m
            file: ../../common/assert/pipeline-ready.yaml

    - name: Simple-demo instrumented after upgrade
      try:
        - assert:
            file: ../../common/assert/simple-demo-instrumented.yaml

    - name: Generate Traffic
      try:
        - apply:
            file: ../../common/apply/generate-traffic-job.yaml
        - script:
            timeout: 1m
            content: |
              kubectl wait --for=condition=complete job/$(kubectl get -f ../../common/apply/generate-traffic-job.yaml -o=jsonpath='{.metadata.name}')
        - delete:
            file: ../../common/apply/generate-traffic-job.yaml

    - name: Wait For Trace
      try:
        - script:
            timeout: 1m
            content: |
              while true; do
                ../../common/simple_trace_db_query_runner.sh ../../common/queries/wait-for-trace.yaml
                if [ $? -eq 0 ]; then
                  break
                fi
                sleep 1
              done
      catch:
        - script:
            content: |
              java_pod_name=$(kubectl get pods -n default -o jsonpath="{.items[*].metadata.name}" | tr ' ' '\n' | grep ^frontend)
              kubectl logs $java_pod_name -n default

    - name: Verify Trace - Context Propagation
      try:
        - script:
            content: |
              ../../common/simple_trace_db_query_runner.sh ../../common/queries/context-propagation.yaml
      catch:
        - podLogs:
            name: odiglet
            namespace: odigos-test

    - name: Verify Trace - Resource Attributes
      try:
        - script:
            content: |
              ../../common/simple_trace_db_query_runner.sh ../../common/queries/resource-attributes.yaml
      catch:
        - podLogs:
            name: odiglet
            namespace: odigos-test

    - name: Verify Trace - Span Attributes
      try:
        - script:
            content: |
              ../../common/simple_trace_db_query_runner.sh ../../common/queries/span-attributes.yaml
      catch:
        - podLogs:
            name: odiglet
            namespace: odigos-test

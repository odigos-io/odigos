# Odigos End to End Testing
In addition to unit tests, Odigos has a suite of end-to-end tests that are run on every pull request.
These tests are installing multiple microservices, instrument with Odigos, generate traffic, and validate the results.

## Tools
- [Kubernetes In Docker (KinD)](https://kind.sigs.k8s.io/) - a tool for running local Kubernetes clusters using Docker container “nodes”.
- [Chainsaw](https://kyverno.github.io/chainsaw/) - To orchestrate the different Kubernetes actions.
- [Tempo](https://github.com/grafana/tempo) - Distributed tracing backend. Chosen due to its query language that allows for easy querying of traces.

## Running e2e locally
To run the end-to-end tests you need to have the following:
- kubectl configured to a fresh Kubernetes cluster. For local development, you can use KinD but also managed clusters like EKS should work.
- yq and jq installed. You can install it via:
```bash
brew install yq
brew install jq
```
- Odigos cli compiled at `cli` folder. Compile via:
```bash
go build -tags=embed_manifests -o ./cli/odigos ./cli
```
- Odigos images tagged with `e2e-test` preloaded to the cluster. If you are using KinD you can run:
```bash
TAG=e2e-test make build-images load-to-kind 
```
- Chainsaw binary, installed via one of the following methods:
  - Hombrew:
  ```bash
  brew tap kyverno/chainsaw https://github.com/kyverno/chainsaw
  brew install kyverno/chainsaw/chainsaw
  ```
  - Go:
  ```bash
  go install github.com/kyverno/chainsaw@latest
  ```

To run specific scenarios, for example `multi-apps` run from Odigos root directory:
```bash
chainsaw test tests/e2e/multi-apps
```

## Writing new scenarios
Every scenario should include some/all of the following:
- Install destination (usually Tempo)
- Install test applications
- Install Odigos
- Select apps for instrumentation and configure destination
- Generate traffic
- Validate traces

Scenarios are written in yaml files called `chainsaw-test.yaml` according to the Chainsaw schema.

See the [following document](https://kyverno.github.io/chainsaw/latest/test/) for more information on how to write scenarios.

Scenarios should be placed in the `tests/e2e/<scenraio-name>` directory and TraceQL validations should be placed in the `tests/e2e/<scenraio-name>/traceql` directory.

After writing and testing new scenario, you should also add it to the GitHub Action file location at:
`.github/workflows/e2e.yaml` to run it on every pull request.

## Working with TraceQL
TraceQL is a query language that allows you to query traces in Tempo.
It is used in the end-to-end tests to validate the traces generated by Odigos.

### Connecting to Tempo
In order to run TraceQL queries, you need to connect to Tempo.
Tempo is installed automatically in the e2e test, so if you ran a scenario you can connect to it.
You can do this by port-forwarding the Tempo service:
```bash
kubectl port-forward svc/e2e-tests-tempo 3100:3100 -n traces
```

### Querying traces
Then you can execute TraceQL queries via:
```bash
curl -G -s http://localhost:3100/api/search --data-urlencode 'q={ resource.odigos.version = "e2e-test"}'
```

To get full individual trace you can use the following command:
```bash
curl -G -s http://localhost:3100/api/traces/3debdffae5920741a53d1bd015c62b29
```

For both APIs it is recommended to pipe the results to `jq` for better readability and `less` for paging.

### Writing queries
See [the following document](https://grafana.com/docs/tempo/latest/traceql/) for more information on how to write queries.
In order to add new traceql test, you need to add a new yaml file in the following schema:
```yaml
apiVersion: e2e.tests.odigos.io/v1
kind: TraceTest
description: <Description>
query: |
    <TraceQL Query>
expected:
  count: <Number of expected spans>
```

Once you have the file, you can run the test via:
```bash
tests/e2e/common/traceql_runner.sh <path-to-yaml-file>
```

## Debugging

When tests fail, and it's related to some traceql query not succeeding, it can be useful to setup a grafana ui to commit queries and see the traces that are stored in tempo.

- Install grafana with helm:

```bash
helm install -n traces grafana grafana/grafana --set adminPassword='odigos'
```

- Port forward to the grafana service:

```bash
kubectl port-forward svc/grafana 3080:80 -n traces
```

- Browse to `http://localhost:3080` and login with `admin` and `odigos`.

- Add tempo as a datasource, by going to `Connections -> Data Sources -> Add data source` and selecting `Tempo` as the type. Set the URL to `http://e2e-tests-tempo:3100` and save.

- In grafana left side menu, go to `Explore` and select the tempo datasource. You can now write queries, run them, and see the traces that are stored in tempo to troubleshoot your test issues. example query:

```
{resource.service.name = "coupon"}
```


apiVersion: chainsaw.kyverno.io/v1alpha1
kind: Test
metadata:
  name: cli-upgrade
spec:
  description: Check successful upgrade from latest version of CLI
  skipDelete: true
  steps:
    - name: Prepare destination
      try:
        - apply:
            file: ../../common/apply/simple-trace-db-deployment.yaml

    - name: Install - Simple Demo Apps
      try:
        - apply:
            file: ../../common/apply/install-simple-demo.yaml

    - name: Install Odigos latest release from GitHub for pre upgrade setup
      try:
        - script:
            timeout: 5m
            content: |
              #!/bin/bash

              echo "üßº Cleaning up any existing installation that might be left over from previous runs..."
              ./odigos uninstall || true

              echo "üì¶ Updating Helm repositories..."
              helm repo add odigos https://odigos-io.github.io/odigos/
              helm repo update

              echo "üîç Fetching latest Odigos release from Helm Chart..."
              IMAGE_TAG=$(helm search repo odigos | awk '$1 == "odigos/odigos" {print $3}')
              if [[ -z "$IMAGE_TAG" ]]; then
                echo "‚ùå ERROR: Failed to fetch latest release, aborting..."
              else
                echo "‚úÖ Successfully fetched latest Odigos release from Helm Chart: $IMAGE_TAG"
              fi

              OS=$(uname | tr '[:upper:]' '[:lower:]') # Get the OS name in lowercase
              ARCH=$(uname -m) # Get the system architecture, then convert match GitHub naming conventions
              if [ "$ARCH" = "x86_64" ]; then
                  ARCH="amd64"
              elif [ "$ARCH" = "aarch64" ]; then
                  ARCH="arm64"
              fi

              DOWNLOAD_URL="https://github.com/odigos-io/odigos/releases/download/${IMAGE_TAG}/cli_${IMAGE_TAG#v}_${OS}_${ARCH}.tar.gz"
              echo "‚¨áÔ∏è Downloading Odigos $IMAGE_TAG from: $DOWNLOAD_URL"
              # --retry X: retry up to X times
              # --retry-delay X: wait X second between retries
              # --retry-max-time X: maximum time to spend retrying (X seconds for download)
              curl -L -o odigos-latest-cli.tar.gz --retry 5 --retry-delay 1 --retry-max-time 60 "$DOWNLOAD_URL"
              tar -xvzf odigos-latest-cli.tar.gz

              echo "üöÄ Installing Odigos $IMAGE_TAG from CLI Binary..."
              ./odigos install --ns odigos-test || true
              kubectl label namespace odigos-test odigos.io/system-object="true"
        - assert:
            timeout: 1m
            file: ../../common/assert/latest-odigos-version-installed.yaml

    - name: Assert Trace DB is up
      try:
        - assert:
            timeout: 1m
            file: ../../common/assert/simple-trace-db-running.yaml

    - name: Assert - Simple Demo Apps Installed
      try:
        - assert:
            timeout: 3m
            file: ../../common/assert/simple-demo-installed.yaml

    - name: Instrument Namespace
      try:
        - apply:
            file: ../../common/apply/instrument-default-ns.yaml

    - name: Assert Runtime Detected
      try:
        - assert:
            timeout: 3m
            file: ../../common/assert/simple-demo-runtime-detected.yaml

    - name: Add Destination
      try:
        - apply:
            file: ../../common/apply/add-simple-trace-db-destination.yaml

    - name: Odigos pipeline pods ready
      # We make sure that the pipeline pods are ready before proceeding with the next steps
      # This is intentionally different from pipeline-ready.yaml, which checks for the pipeline CRDs
      # When adding a feature related to the pipeline, if we would use the same assert before the upgrade, the test would fail.
      # Since the version installed here is latest official one.
      try:
        - script:
            content: ../../common/assert_pipeline_pods_ready.sh
            timeout: 5m

    - name: Simple-demo instrumented after destination added
      try:
        - assert:
            file: ../../common/assert/simple-demo-instrumented.yaml

    - name: Upgrade to HEAD version with the current compiled cli
      try:
        - script:
            content: ../../../cli/odigos install --ns odigos-test --set image.tag=e2e-test
            timeout: 3m
        - assert:
            file: ../../common/assert/odigos-upgraded.yaml
            timeout: 3m
      catch:
        - get:
            apiVersion: v1
            kind: Pod

    - name: Odigos pipeline ready after upgrade
      try:
        - assert:
            timeout: 1m
            file: ../../common/assert/pipeline-ready.yaml

    - name: Simple-demo instrumented after upgrade
      try:
        - assert:
            file: ../../common/assert/simple-demo-instrumented.yaml

    - name: Generate Traffic
      try:
        - apply:
            file: ../../common/apply/generate-traffic-job.yaml
        - script:
            timeout: 1m
            content: |
              kubectl wait --for=condition=complete job/$(kubectl get -f ../../common/apply/generate-traffic-job.yaml -o=jsonpath='{.metadata.name}')
        - delete:
            file: ../../common/apply/generate-traffic-job.yaml

    - name: Wait For Trace
      try:
        - script:
            timeout: 1m
            content: |
              while true; do
                ../../common/simple_trace_db_query_runner.sh ../../common/queries/wait-for-trace.yaml
                if [ $? -eq 0 ]; then
                  break
                fi
                sleep 1
              done
      catch:
        - script:
            content: |
              java_pod_name=$(kubectl get pods -n default -o jsonpath="{.items[*].metadata.name}" | tr ' ' '\n' | grep ^frontend)
              kubectl logs $java_pod_name -n default

    - name: Verify Trace - Context Propagation
      try:
        - script:
            content: |
              ../../common/simple_trace_db_query_runner.sh ../../common/queries/context-propagation.yaml
      catch:
        - podLogs:
            name: odiglet
            namespace: odigos-test

    - name: Verify Trace - Resource Attributes
      try:
        - script:
            content: |
              ../../common/simple_trace_db_query_runner.sh ../../common/queries/resource-attributes.yaml
      catch:
        - podLogs:
            name: odiglet
            namespace: odigos-test

    - name: Verify Trace - Span Attributes
      try:
        - script:
            content: |
              ../../common/simple_trace_db_query_runner.sh ../../common/queries/span-attributes.yaml
      catch:
        - podLogs:
            name: odiglet
            namespace: odigos-test

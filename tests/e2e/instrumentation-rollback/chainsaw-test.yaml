apiVersion: chainsaw.kyverno.io/v1alpha1
kind: Test
metadata:
  name: instrumentation-rollback
spec:
  description: This test checks if a broken instrumentation is rolled back correctly.
  skipDelete: true
  steps:
    - name: Prepare destination
      try:
        - apply:
            file: ../../common/apply/simple-trace-db-deployment.yaml

    - name: Install Odigos
      try:
        - script:
            timeout: 3m
            content: |
              # The pwd is the directory of this file, so we have to walk up to the project root to find the helm chart
              P="../../.."
              if [ "$MODE" = "cross-cloud-tests" ]; then
                helm upgrade --install odigos $P/helm/odigos --create-namespace --namespace odigos-test --set image.tag="$COMMIT_HASH" --set imagePrefix=public.ecr.aws/y2v0v6s7 --set nodeSelector."kubernetes\.io/os"=linux --set autoRollback.graceTime=90s
              else
                helm upgrade --install odigos $P/helm/odigos --create-namespace --namespace odigos-test --set image.tag=e2e-test  --set nodeSelector."kubernetes\.io/os"=linux --set autoRollback.graceTime=90s
              fi
              kubectl label namespace odigos-test odigos.io/system-object="true"

    - name: Verify Odigos Installation
      try:
        - script:
            timeout: 6m
            content: |
              echo "Starting Odigos version check..."
              export ACTUAL_VERSION=$(../../../cli/odigos version --cluster)
              echo "Actual Version: $ACTUAL_VERSION"
              echo "Commit Hash: $COMMIT_HASH"

              if [ "$MODE" = "cross-cloud-tests" ]; then
                if [ "$ACTUAL_VERSION" != "$COMMIT_HASH" ]; then
                  echo "‚ùå Odigos version is not the expected commit hash, got $ACTUAL_VERSION"
                  exit 1
                fi

              else
                if [ "$ACTUAL_VERSION" != "e2e-test" ]; then
                  echo "‚ùå Odigos version is not e2e-test, got $ACTUAL_VERSION"
                  exit 1
                fi
              fi

              ../../common/verify_odigos_installation.sh odigos-test
        - assert:
            timeout: 3m
            file: ../../common/assert/odigos-installed.yaml
      catch:
        - script:
            content: |
              echo "üîç Listing all resources in namespace 'odigos-test'..."
              kubectl get all -n odigos-test

              echo "üìù Describing all resources in namespace 'odigos-test'..."
              kubectl describe all -n odigos-test

    - name: Verify Node Odiglet label has been added
      try:
        - assert:
            file: ../../common/assert/node-odiglet-label.yaml

    - name: Assert Trace DB is up
      try:
        - assert:
            timeout: 1m
            file: ../../common/assert/simple-trace-db-running.yaml

    - name: Install - crash demo app
      try:
        - apply:
            file: ../../common/apply/install-crash-demo.yaml
        - script:
            timeout: 3m
            content: |
              echo "Waiting for 5 seconds before checking deployment status..."
              sleep 5

              # Try to wait for rollout, but don't fail if it doesn't work
              echo "=== Attempting deployment rollout ==="
              if ! kubectl rollout status deployment/otel-crash-demo --timeout=120s; then
                echo "‚ùå Deployment rollout failed, debugging..."
              else
                echo "‚úÖ Deployment rollout succeeded"
              fi

              # Try to wait for pod ready, but don't fail if it doesn't work
              echo "=== Attempting to wait for pod ready ==="
              if ! kubectl wait --for=condition=ready pod -l app=otel-crash-demo --timeout=30s; then
                echo "‚ùå Pod ready condition failed, debugging..."
              else
                echo "‚úÖ Pod ready condition succeeded"
                exit 0  # Success, no need to debug
              fi

              echo "=== Debugging crash demo startup ==="
              kubectl get pods -l app=otel-crash-demo -o wide

              echo "=== Pod describe ==="
              kubectl describe pods -l app=otel-crash-demo

              echo "=== Container logs ==="
              POD_NAME=$(kubectl get pods -l app=otel-crash-demo -o jsonpath='{.items[0].metadata.name}')
              if [ ! -z "$POD_NAME" ]; then
                echo "--- Previous logs ---"
                kubectl logs $POD_NAME --previous || echo "No previous logs"
                echo "--- Current logs ---"
                kubectl logs $POD_NAME || echo "No current logs"
              fi

              echo "=== Events ==="
              kubectl get events --field-selector involvedObject.kind=Pod --sort-by='.lastTimestamp' | grep otel-crash-demo || echo "No pod events"

              # Exit with failure since debugging was triggered
              exit 1
        - assert:
            file: ../../common/assert/crash-demo/crash-demo-installed.yaml

    - name: Instrument Namespace
      try:
        - apply:
            file: ../../common/apply/instrument-default-ns.yaml

    - name: Add Destination
      try:
        - apply:
            file: ../../common/apply/add-simple-trace-db-destination.yaml

    - name: Odigos pipeline ready
      try:
        - assert:
            timeout: 1m
            file: ../../common/assert/pipeline-ready.yaml

    - name: Assert rollback grace time configured
      try:
        - script:
            timeout: 30s
            content: ../../common/assert_config_value.sh -k rollbackGraceTime -v 90s

    - name: Test crash demo in crashloop
      try:
        - assert:
            timeout: 2m
            file: ../../common/assert/crash-demo/crash-demo-in-crashloop.yml

    - name: Test crash demo uninstrumented
      try:
        - assert:
            timeout: 3m
            file: ../../common/assert/crash-demo/crash-demo-uninstrumented.yaml
